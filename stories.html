<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Memoir â€” My Stories</title>
</head>
<body>
  <!-- shared header -->
  <!-- paste the SHARED HEADER block here -->

  <div class="container">
    <section class="card" style="padding:16px">
      <h2 data-i18n="my_stories">My Stories</h2>
      <div id="stats" class="muted" style="margin-bottom:12px"></div>

      <div class="grid two">
        <div class="card" style="padding:12px">
          <strong data-i18n="invite_family">Invite a family member</strong>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="invEmail" class="input" placeholder="name@family.com" data-i18n-placeholder="invite_email_ph">
            <button id="invBtn" class="btn" data-i18n="send_invite">Send invite</button>
          </div>
          <div id="invMsg" class="muted" style="margin-top:6px"></div>
        </div>
        <div></div>
      </div>

      <div id="list" style="margin-top:16px"></div>
    </section>
  </div>

<script>
const supabaseClient = window.supabase.createClient(
  "https://jrjqciywlijhhcxfxywh.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpyanFjaXl3bGlqaGhjeGZ4eXdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MDQ2NzEsImV4cCI6MjA3MTA4MDY3MX0.5FeQxu_N7q-1Br00yJu4E-TKTZK4U4ZnJ4jpRo7Atak",
  { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:false } }
);

let userId=null;
(async()=>{
  const { data:{session} } = await supabaseClient.auth.getSession();
  if(!session){ location.replace('login.html'); return; }
  userId = session.user.id;
  applyI18N();
  await loadCountsAndList();
})();

async function loadCountsAndList(){
  // Count stories
  const { count } = await supabaseClient
    .from('stories')
    .select('id', { count:'exact', head:true })
    .eq('user_id', userId);

  document.getElementById('stats').textContent = t('you_have_x_stories', count||0);

  // List stories
  const { data } = await supabaseClient
    .from('stories')
    .select('id,title,created_at,photo_url,transcript')
    .eq('user_id', userId)
    .order('created_at',{ascending:false});

  const list = document.getElementById('list'); list.innerHTML='';
  if(!data?.length){ list.innerHTML='<div class="muted">No stories yet.</div>'; return; }

  data.forEach(s=>{
    const row = document.createElement('div');
    row.className='card'; row.style.padding='12px'; row.style.margin='10px 0';
    row.innerHTML = `
      <div style="display:flex; gap:12px; align-items:center">
        <img src="${s.photo_url||'assets/book-2.jpg'}" style="width:64px;height:64px;object-fit:cover;border-radius:12px;border:1px solid #eee"/>
        <div style="flex:1">
          <div style="font-weight:700">${s.title||'Story'}</div>
          <div class="muted" style="font-size:12px">${new Date(s.created_at).toLocaleString()}</div>
        </div>
        <div style="display:flex; gap:8px">
          <button class="btn" onclick="view(${JSON.stringify(s.id)})">View</button>
          <label class="btn">
            Change photo
            <input type="file" accept="image/*" style="display:none" onchange="changePhoto('${s.id}', this.files[0])">
          </label>
          <button class="btn" onclick="delStory('${s.id}')">Delete</button>
        </div>
      </div>
    `;
    list.appendChild(row);
  });
}

function view(id){ location.href=`/story.html?id=${encodeURIComponent(id)}`; }

async function changePhoto(id, file){
  try{
    const path = `${userId}/${Date.now()}-${file.name||'photo.jpg'}`;
    const up = await supabaseClient.storage.from('memoir-images').upload(path, file, { upsert:false });
    if(up.error) throw up.error;
    const { data:pub } = supabaseClient.storage.from('memoir-images').getPublicUrl(path);
    const { error } = await supabaseClient.from('stories').update({ photo_url: pub.publicUrl }).eq('id', id).eq('user_id', userId);
    if(error) throw error;
    await loadCountsAndList();
  }catch(e){ alert('Photo update failed: '+(e.message||e)); }
}

async function delStory(id){
  if(!confirm('Delete this story?')) return;
  const { error } = await supabaseClient.from('stories').delete().eq('id', id).eq('user_id', userId);
  if(error){ alert(error.message); return; }
  await loadCountsAndList();
}

// simple invite placeholder (wire to your families table later)
document.getElementById('invBtn').onclick = ()=>{
  const email = (document.getElementById('invEmail').value||'').trim();
  document.getElementById('invMsg').textContent = email ? `Invite sent to ${email}.` : 'Enter an email.';
};
</script>
</body>
</html>
