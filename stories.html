<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>My Stories â€” Memoir</title>
<link rel="stylesheet" href="/styles.css"/>
</head>
<body>

<nav class="nav">
  <div class="nav-inner container">
    <div class="brand"><div class="logo"></div> Memoir</div>
    <div class="links">
      <a class="btn" href="/landing.html">About</a>
      <a class="btn" href="/record.html">Record</a>
      <select class="btn" data-lang>
        <option value="en">ðŸ‡¬ðŸ‡§ English</option>
        <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
        <option value="nl">ðŸ‡³ðŸ‡± Nederlands</option>
        <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
      </select>
      <a class="btn" href="/login.html">Login</a>
    </div>
  </div>
</nav>

<main class="container">
  <section class="card">
    <h2 style="margin:0 0 10px">My Stories</h2>
    <div id="list" style="display:grid;gap:12px"></div>
  </section>
</main>

<script>
  window.ENV = { SUPABASE_URL: "{{SUPABASE_URL}}", SUPABASE_ANON_KEY: "{{SUPABASE_ANON_KEY}}" };
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1/dist/umd/supabase.js"></script>
<script src="/app.js"></script>
<script>
(async function(){
  const supabase = window.supabaseClient;
  const { data:{session} } = await supabase.auth.getSession();
  if(!session){ window.location.replace('/login.html'); return; }
  const user=session.user;

  const list=document.getElementById('list');
  function esc(s){ return String(s||'').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

  async function load(){
    const { data, error } = await supabase
      .from('stories')
      .select('id,title,transcript,created_at,happened_label,happened_sort,image_path')
      .eq('user_id', user.id)
      .order('created_at',{ascending:false});
    if (error){ list.innerHTML='<div class="muted">Error loading.</div>'; return; }
    if(!data?.length){ list.innerHTML='<div class="muted">No stories yet.</div>'; return; }

    list.innerHTML='';
    data.forEach(s=>{
      const url = s.image_path ? supabase.storage.from('memoir-images').getPublicUrl(s.image_path).data.publicUrl : null;
      const item=document.createElement('div'); item.className='card';
      item.innerHTML = `
        <div style="display:grid;grid-template-columns:80px 1fr;gap:12px;align-items:center">
          <div class="thumb" style="height:64px;overflow:hidden">${ url ? `<img src="${url}" style="width:100%;height:100%;object-fit:cover">` : '' }</div>
          <div>
            <div style="font-weight:700">${esc(s.title||'Story')}</div>
            <div class="muted">${esc(s.happened_label || (s.happened_sort?new Date(s.happened_sort).toDateString():new Date(s.created_at).toLocaleString()))}</div>
          </div>
        </div>
        <div class="segment" style="margin-top:10px">
          <button class="btn" data-view>View</button>
          <button class="btn" data-download>Download .txt</button>
          <button class="btn" data-delete>Delete</button>
        </div>
      `;
      item.querySelector('[data-view]').onclick=()=>{
        const dlg=document.createElement('dialog'); dlg.style.border='0'; dlg.style.borderRadius='12px'; dlg.style.padding='0';
        dlg.innerHTML = `
          <form method="dialog" style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #eee">
            <strong>${esc(s.title||'Story')}</strong>
            <button class="btn">Close</button>
          </form>
          <div style="padding:16px">
            ${ url ? `<img src="${url}" style="max-height:240px;border-radius:10px;margin-bottom:10px">` : '' }
            <div class="muted" style="margin-bottom:6px">${esc(s.happened_label || (s.happened_sort?new Date(s.happened_sort).toDateString():new Date(s.created_at).toLocaleString()))}</div>
            <div style="white-space:pre-wrap">${esc(s.transcript||'')}</div>
          </div>`;
        document.body.appendChild(dlg); dlg.addEventListener('close',()=>dlg.remove()); dlg.showModal();
      };
      item.querySelector('[data-download]').onclick=()=>{
        const blob = new Blob([s.transcript||''],{type:'text/plain'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(s.title||'story')+'.txt'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
      };
      item.querySelector('[data-delete]').onclick= async ()=>{
        if(!confirm('Delete this story?')) return;
        const { error } = await supabase.from('stories').delete().eq('id', s.id).eq('user_id', user.id);
        if (error) return alert(error.message);
        load();
      };
      list.appendChild(item);
    });
  }
  load();
})();
</script>
</body>
</html>
