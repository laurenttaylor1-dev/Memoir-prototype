<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Memoir — My Stories</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    :root{--bg:#f6f1ea;--ink:#3b2f2a;--muted:#7b6a62;--card:#fffaf5;--accent:#8c5a3c;--accent2:#b17d55;--radius:18px}
    body{background:var(--bg);color:var(--ink);margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:1200px;margin:0 auto;padding:20px 16px 28px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:960px){ .grid{grid-template-columns: 320px 1fr} }
    .stat{font-size:14px;color:var(--muted)}
    .stat strong{display:block;font-size:28px;color:var(--ink)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid rgba(0,0,0,.12);background:#fff;text-decoration:none;color:var(--ink);font-weight:600}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border:0}
    .list{display:grid;gap:10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .story{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:12px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div id="site-header"></div>

  <main class="container">
    <h1 style="margin:8px 0 16px" data-i18n="myStories">My Stories</h1>
    <p class="muted" id="storiesBlurb" style="margin:0 0 16px">
      Record once, keep for generations. Start a recording in one tap, add a title and “when it happened”, then share safely with your family.
    </p>

    <section class="grid">
      <!-- Left column: stats + invite -->
      <aside class="mk-card">
        <div class="stat"><strong id="statStories">0</strong>Stories</div>
        <div class="stat" style="margin-top:10px"><strong id="statMembers">0</strong>Family Members</div>

        <div style="margin-top:18px">
          <label class="muted" for="inviteEmail">Invite Family Member</label>
          <div class="row" style="margin-top:6px">
            <input id="inviteEmail" type="email" placeholder="email@example.com" style="flex:1;padding:10px 12px;border:1px solid rgba(0,0,0,.15);border-radius:12px;background:#fff">
            <button id="inviteBtn" class="btn">Invite</button>
          </div>
          <div id="inviteMsg" class="muted" style="margin-top:6px"></div>
        </div>
      </aside>

      <!-- Right column: list -->
      <section class="mk-card">
        <h3 style="margin:0 0 10px">My Stories</h3>
        <div id="storiesList" class="list"></div>
      </section>
    </section>
  </main>

  <div id="site-footer"></div>

  <script src="/js/lang.js" defer></script>
  <script src="/js/header-loader.js" defer></script>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1/+esm";

    const SUPABASE_URL = window.__SB_URL__;
    const SUPABASE_ANON = window.__SB_ANON__;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:false } });

    const listEl = document.getElementById('storiesList');
    const statStories = document.getElementById('statStories');
    const statMembers = document.getElementById('statMembers');

    async function load() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        listEl.innerHTML = `<div class="muted">Please log in to see your stories.</div>`;
        return;
      }

      // count stories
      const { data: stories, error } = await supabase
        .from('stories')
        .select('id, title, happened_label, created_at', { count: 'exact' })
        .order('created_at', { ascending: false });

      if (error) {
        listEl.innerHTML = `<div class="muted">Failed to load stories.</div>`;
        return;
      }
      statStories.textContent = stories?.length || 0;

      // TODO: when you add family_members, use its count. For now 0.
      statMembers.textContent = 0;

      if (!stories?.length) {
        listEl.innerHTML = `<div class="muted">No stories yet.</div>`;
        return;
      }

      listEl.innerHTML = '';
      stories.forEach(s => {
        const div = document.createElement('div');
        div.className = 'story';
        div.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
            <div>
              <strong>${(s.title || 'Story').replace(/[<&]/g, '')}</strong>
              <div class="muted">${s.happened_label ? s.happened_label : new Date(s.created_at).toLocaleString()}</div>
            </div>
            <div class="row">
              <a class="btn" href="/record.html?edit=${encodeURIComponent(s.id)}">Open</a>
            </div>
          </div>`;
        listEl.appendChild(div);
      });
    }

    load();
  </script>
</body>
</html>
