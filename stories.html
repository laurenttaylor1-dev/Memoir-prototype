<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>My Stories â€” Memoir</title>
<link rel="stylesheet" href="/styles.css">
<link rel="icon" href="data:,">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1/dist/umd/supabase.js"></script>
</head>
<body>
<nav class="nav">
  <div class="nav-inner container">
    <div class="brand"><div class="logo"></div><div>MEMOIR APP</div></div>
    <div class="nav-links">
      <a href="/index.html" class="link">Home</a>
      <a href="/record.html" class="link needs-auth">Record</a>
      <a href="/login.html" class="link" id="nav-login">Login</a>
      <select id="lang" class="lang">
        <option value="en">ðŸ‡¬ðŸ‡§ English</option>
        <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
        <option value="nl">ðŸ‡³ðŸ‡± Nederlands</option>
        <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
      </select>
      <span id="userBadge" class="badge hidden"></span>
      <button id="logoutBtn" class="btn pill ghost">Logout</button>
    </div>
  </div>
</nav>

<main class="container">
  <section class="section">
    <div class="card">
      <div class="kicker">Your Library</div>
      <h1 style="margin-top:6px">My Stories</h1>
      <div id="list" class="features" style="grid-template-columns:repeat(auto-fill,minmax(280px,1fr))"></div>
    </div>
  </section>
</main>

<script src="/app.js"></script>
<script>
// For now read from localStorage (same key as before)
const LSKEY='memoir.stories';
const list = document.getElementById('list');

function esc(s){return String(s||'').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]))}

function render(){
  let items=[];
  try{ items = JSON.parse(localStorage.getItem(LSKEY)||'[]'); }catch{}
  list.innerHTML='';
  if(!items.length){
    const p=document.createElement('p'); p.className='muted'; p.textContent='No stories yet.';
    list.appendChild(p); return;
  }
  items.forEach((s,idx)=>{
    const card=document.createElement('div'); card.className='feature';
    card.innerHTML = `
      <h4>${esc(s.title||'Story')}</h4>
      <p class="small">${esc(s.happened_label || (s.happened_sort||'').slice(0,10) || new Date(s.created).toLocaleString())}</p>
      <p class="muted" style="height:3.5em;overflow:hidden">${esc((s.text||'').slice(0,160))}â€¦</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn pill ghost" data-view="${idx}">View</button>
        <button class="btn pill" data-dl="${idx}">Download .txt</button>
        <button class="btn pill ghost" data-del="${idx}">Delete</button>
      </div>`;
    list.appendChild(card);
  });
}
list.addEventListener('click', (e)=>{
  const items = JSON.parse(localStorage.getItem(LSKEY)||'[]');
  const view = e.target.getAttribute('data-view');
  const dl = e.target.getAttribute('data-dl');
  const del = e.target.getAttribute('data-del');
  if(view!==null){
    const s=items[+view]; alert((s?.title||'Story')+'\n\n'+(s?.text||''));
  }else if(dl!==null){
    const s=items[+dl];
    const blob=new Blob([s?.text||''],{type:'text/plain'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(s?.title||'story')+'.txt'; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),1000);
  }else if(del!==null){
    if(confirm('Delete this story?')){ items.splice(+del,1); localStorage.setItem(LSKEY,JSON.stringify(items)); render(); }
  }
});
render();
</script>
</body>
</html>
