<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>My Stories — Memoir</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1/dist/umd/supabase.js"></script>
</head>
<body>
  <div id="site-header"></div>
  <script src="/js/header.js"></script>

  <main class="mk-container mk-grid cols-2">
    <section class="mk-card" style="padding:18px">
      <h2 class="mk-h2">Your stats</h2>
      <div class="mk-grid cols-3">
        <div><div class="mk-badge">Stories</div><h3 id="countStories" class="mk-h2">—</h3></div>
        <div><div class="mk-badge">Family members</div><h3 id="countMembers" class="mk-h2">—</h3></div>
        <div><div class="mk-badge">Plan</div><h3 id="planName" class="mk-h2">—</h3></div>
      </div>

      <div style="margin-top:14px">
        <label class="mk-muted">Share read-only with a family email</label>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px">
          <input id="shareEmail" placeholder="family@example.com" style="flex:1; padding:10px; border:1px solid var(--mk-border); border-radius:12px">
          <button id="btnShare" class="mk-cta outline">Share</button>
        </div>
        <div id="shareMsg" class="mk-muted" style="margin-top:6px"></div>
      </div>
    </section>

    <aside class="mk-card" style="padding:18px">
      <h2 class="mk-h2">Library</h2>
      <div id="library">Loading…</div>
    </aside>
  </main>

  <script>
    const SUPABASE_URL = "https://jrjqciywlijhhcxfxywh.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpyanFjaXl3bGlqaGhjeGZ4eXdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MDQ2NzEsImV4cCI6MjA3MTA4MDY3MX0.5FeQxu_N7q-1Br00yJu4E-TKTZK4U4ZnJ4jpRo7Atak";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{persistSession:true,detectSessionInUrl:false} });

    async function load(){
      const { data:{ user } } = await sb.auth.getUser();
      if(!user){ location.href='/login.html'; return; }

      // Count stories
      const { count } = await sb.from('stories').select('id', { count:'exact', head:true }).eq('user_id', user.id);
      document.getElementById('countStories').textContent = count ?? 0;

      // Plan + members (simple placeholders unless you’ve wired family tables)
      const { data: prof } = await sb.from('profiles').select('plan').single();
      document.getElementById('planName').textContent = prof?.plan || 'free';

      // If you created family_members earlier, you can count them here. Otherwise show 0.
      document.getElementById('countMembers').textContent = 0;

      // List stories
      const { data: list } = await sb.from('stories')
        .select('id,title,created_at,happened_label')
        .eq('user_id', user.id)
        .order('created_at', { ascending:false });

      const wrap = document.getElementById('library');
      wrap.innerHTML = '';
      (list||[]).forEach(s=>{
        const row=document.createElement('div');
        row.className='mk-card'; row.style.padding='10px'; row.style.marginBottom='8px';
        row.innerHTML = `<div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
          <div><strong>${s.title}</strong><div class="mk-muted">${s.happened_label||new Date(s.created_at).toLocaleString()}</div></div>
          <a class="mk-chip" href="/record.html">Open</a>
        </div>`;
        wrap.appendChild(row);
      });

      document.getElementById('btnShare').onclick = ()=>{
        const email = document.getElementById('shareEmail').value.trim();
        document.getElementById('shareMsg').textContent = email ? `Invite queued for: ${email}` : 'Enter an email first.';
      };
    }
    load();
  </script>
</body>
</html>
