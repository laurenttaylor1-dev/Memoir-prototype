<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Register — Memoir</title>

  <!-- Supabase config via meta (CSP-friendly, same project values) -->
  <meta name="supabase-url"  content="https://fswxkujxusdozvmpyvzk.supabase.co">
  <meta name="supabase-anon" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzd3hrdWp4dXNkb3p2bXB5dnprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMTk3MTYsImV4cCI6MjA3MzY5NTcxNn0.kNodFgDXi32w456e475fXvBi9eehX50HX_hVVTDBtXI">

  <link rel="stylesheet" href="/styles.css">
  <style>
    :root{--bg:#f6f1ea;--card:#fffaf5;--ink:#3b2f2a;--muted:#7b6a62;--accent:#8c5a3c;--accent2:#b17d55;--radius:18px;--shadow:0 18px 40px rgba(59,47,42,.10),0 2px 8px rgba(59,47,42,.06)}
    body{background:var(--bg);color:var(--ink);margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    main{display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;min-height:100vh;text-align:center;padding:16px}
    form{display:flex;flex-direction:column;gap:10px;min-width:min(420px,92vw);max-width:420px;margin:0 auto;background:var(--card);border:1px solid rgba(0,0,0,.08);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    input, select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(0,0,0,.15);background:#fff;color:inherit;box-sizing:border-box}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:999px;border:1px solid rgba(0,0,0,.12);background:#fff;color:var(--ink);font-weight:700;cursor:pointer;text-decoration:none}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border:0}
    .muted{color:var(--muted)}
    .status{min-height:1.1em;font-size:14px;margin-top:6px}
  </style>
</head>
<body>
  <main>
    <h1>Create your account</h1>
    <form id="register-form" novalidate>
      <input id="name" type="text" placeholder="Your name" required />
      <input id="email" type="email" placeholder="you@email.com" required />
      <input id="password" type="password" placeholder="Password (min 6 chars)" required />
      <select id="subscription">
        <option value="free" selected>Free</option>
        <option value="storyteller">Storyteller (3h/mo)</option>
        <option value="premium">Premium Storyteller (6h/mo)</option>
        <option value="exclusive">Exclusive Storyteller (10h/mo)</option>
      </select>
      <button type="submit" class="btn primary">Create account</button>
      <div id="reg-status" class="status muted"></div>
      <p class="muted">Already have an account? <a href="/auth/sign-in.html">Sign in</a></p>
    </form>
  </main>

  <!-- External scripts only -->
  <script src="/js/auth-client.js" defer></script>
  <script src="/js/auth-register.js" defer></script>
  <script src="/js/supabase-client.js" defer></script>
  <script>
    // Small helper: show nicer messages for common Supabase Auth errors
    function showAuthError(error, targetEl) {
      const raw = (error?.message || '').toLowerCase();

      if (raw.includes('leaked') || raw.includes('pwned') || raw.includes('breach')) {
        targetEl.textContent = 'This password appears in known data breaches. Please choose a stronger one.';
        return;
      }
      if (raw.includes('password') && raw.includes('too short')) {
        targetEl.textContent = 'Password is too short. Please use at least 10 characters.';
        return;
      }
      if (raw.includes('password') && raw.includes('policy')) {
        targetEl.textContent = 'Password does not meet the required policy.';
        return;
      }
      targetEl.textContent = error?.message || 'Something went wrong.';
    }

    // ---- Register flow ----
    let supabaseClient = null;
    document.addEventListener('DOMContentLoaded', async () => {
      // Ensure SDK is ready
      if (!window.supabase?.createClient) {
        await new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
          s.onload = resolve; s.onerror = reject;
          document.head.appendChild(s);
        });
      }
      supabaseClient = window.supabase.createClient(
        window.MEMOIR_SUPABASE_URL || document.querySelector('meta[name="supabase-url"]')?.content,
        window.MEMOIR_SUPABASE_ANON || document.querySelector('meta[name="supabase-anon"]')?.content
      );
    });

    document.getElementById('register-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const status = document.getElementById('reg-status');
      status.textContent = 'Creating account…';

      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const subscription = document.getElementById('subscription').value;

      // Optional client-side guard (still rely on server policy):
      if (password.length < 10) {
        status.textContent = 'Please use at least 10 characters for your password.';
        return;
      }

      try {
        const { data, error } = await supabaseClient.auth.signUp({
          email,
          password,
          options: {
            data: { full_name: name || null }, // store name in user metadata
            emailRedirectTo: location.origin + "/auth/sign-in.html"
          }
        });
        if (error) {
          showAuthError(error, status);
          return;
        }

        const userId = data?.user?.id;
        if (userId) {
          // Keep column names aligned with your schema
          const { error: pErr } = await supabaseClient
            .from('profiles')
            .insert({
              user_id: userId,           // <- your schema uses user_id
              full_name: name || null,   // <- used elsewhere for greeting
              subscription_plan: subscription || 'free'
            });
          if (pErr) {
            // Not fatal for sign-up; just show info
            console.warn('profiles insert failed', pErr);
          }
        }

        status.textContent = "Account created! Check your email to confirm, then sign in.";
        setTimeout(() => location.href = "/auth/sign-in.html", 1200);
      } catch (err) {
        showAuthError(err, status);
      }
    });
</script>
</body>
</html>
