<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Memoir — Redeem code</title>
  <link rel="stylesheet" href="/partials/styles.css">
</head>
<body>
  <div id="site-header"></div>

  <main class="container" style="max-width:560px;margin:32px auto;padding:16px">
    <h1>Redeem a code</h1>
    <form id="form">
      <input id="code" placeholder="Enter your code" required style="width:100%;padding:12px;border-radius:12px;border:1px solid #ccc"/>
      <button class="btn primary" type="submit" style="margin-top:10px">Apply</button>
    </form>
    <div id="msg" style="margin-top:10px;min-height:1.2em"></div>
  </main>

  <div id="site-footer"></div>

  <script src="/js/header-loader.js"></script>
  <script src="/js/footer-loader.js"></script>
  <script src="/js/supabase-client.js"></script>
  <script>
  (async ()=>{
    const msg = document.getElementById('msg');
    const { data: { user } } = await MEMOIR_SB.auth.getUser();
    if (!user) { msg.textContent='Please sign in first.'; return; }

    document.getElementById('form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const code = document.getElementById('code').value.trim();
      if (!code) return;
      msg.textContent='Applying…';
      const { data, error } = await MEMOIR_SB.rpc('redeem_code', { p_code: code });
      if (error) { msg.style.color='#a33'; msg.textContent = error.message || 'Error'; return; }
      const res = data?.[0];
      if (res?.applied) { msg.style.color='#2d6a4f'; msg.textContent = 'Success: ' + (res.message || 'Applied'); }
      else { msg.style.color='#a33'; msg.textContent = res?.message || 'Could not apply the code.'; }
    });
  })();
  </script>
</body>
</html>
