<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Memoir — Login</title>

  <!-- Your site-wide stylesheet -->
  <link rel="stylesheet" href="/partials/styles.css"/>

  <!-- Supabase config (inline so it always runs on this page) -->
  <script>
    window.MEMOIR_SUPABASE_URL  = "https://fswxkujxusdozvmpyvzk.supabase.co";
    window.MEMOIR_SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzd3hrdWp4dXNkb3p2bXB5dnprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMTk3MTYsImV4cCI6MjA3MzY5NTcxNn0.kNodFgDXi32w456e475fXvBi9eehX50HX_hVVTDBtXI";
  </script>
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Shared header -->
  <div id="site-header"></div>

  <main class="container" style="max-width:760px">
    <h1 class="title" data-i18n="loginTitle">Sign in</h1>

    <!-- Sign-in card -->
    <section class="card" id="signinCard">
      <form id="loginForm" novalidate>
        <div class="field">
          <label for="email" data-i18n="loginEmailLabel">Email</label>
          <input id="email" name="email" type="email" autocomplete="username" required placeholder="you@email.com">
        </div>

        <div class="field">
          <label for="password" data-i18n="loginPasswordLabel">Password</label>
          <input id="password" name="password" type="password" autocomplete="current-password" required placeholder="Your password">
        </div>

        <div class="actions">
          <button id="loginSubmit" class="btn primary" type="submit" data-i18n="loginSubmit">Sign in</button>
          <button class="btn" type="button" id="openReset">Forgot your password?</button>
          <button class="btn" type="button" id="openRegister">Create account</button>
        </div>

        <div id="loginError" class="error" role="status" aria-live="polite"></div>
      </form>
    </section>

    <!-- Register (inline, hidden by default) -->
    <section class="card" id="registerCard" hidden>
      <h2 class="title" style="font-size:22px;margin-top:0">Create your account</h2>
      <form id="registerForm" novalidate>
        <div class="field">
          <label for="reg_name">Your name</label>
          <input id="reg_name" required placeholder="Your name">
        </div>

        <div class="field">
          <label for="reg_username">Username (optional)</label>
          <input id="reg_username" placeholder="your username">
        </div>

        <div class="field">
          <label for="reg_email">Email</label>
          <input id="reg_email" type="email" required placeholder="you@email.com">
        </div>

        <div class="field">
          <label for="reg_password">Password (min 6 chars)</label>
          <input id="reg_password" type="password" minlength="6" required>
        </div>

        <div class="field">
          <label for="reg_plan">Plan</label>
          <select id="reg_plan">
            <option value="free" selected>Free</option>
            <option value="storyteller">Storyteller (3h)</option>
            <option value="premium">Premium (6h)</option>
            <option value="exclusive">Exclusive (10h)</option>
          </select>
        </div>

        <div class="field" style="display:flex;gap:10px;align-items:flex-start">
          <input id="reg_gdpr" type="checkbox" required>
          <label for="reg_gdpr">I agree to the <a href="/partials/legal.html" target="_blank">Terms & Privacy</a>.</label>
        </div>

        <div class="actions">
          <button class="btn primary" type="submit">Create account</button>
          <button class="btn" type="button" id="closeRegister">Back to sign in</button>
        </div>

        <div id="registerMsg" class="helper" role="status" aria-live="polite"></div>
      </form>
    </section>

    <!-- Request reset (inline, hidden by default) -->
    <section class="card" id="resetRequestCard" hidden>
      <h2 class="title" style="font-size:22px;margin-top:0">Reset your password</h2>
      <form id="resetRequestForm" novalidate>
        <div class="field">
          <label for="reset_email">Your email</label>
          <input id="reset_email" type="email" required placeholder="you@email.com">
        </div>
        <div class="actions">
          <button class="btn primary" type="submit">Send reset link</button>
          <button class="btn" type="button" id="closeReset">Back to sign in</button>
        </div>
        <div id="resetMsg" class="helper" role="status" aria-live="polite"></div>
      </form>
    </section>

    <!-- New password (auto-shown when arriving from email link) -->
    <section class="card" id="newPasswordCard" hidden>
      <h2 class="title" style="font-size:22px;margin-top:0">Set a new password</h2>
      <form id="newPassForm" novalidate>
        <div class="field">
          <label for="new_password">New password</label>
          <input id="new_password" type="password" minlength="6" required>
        </div>
        <div class="actions">
          <button class="btn primary" type="submit">Update password</button>
          <button class="btn" type="button" id="closeNewPass">Back to sign in</button>
        </div>
        <div id="newPassMsg" class="helper" role="status" aria-live="polite"></div>
      </form>
    </section>
  </main>

  <!-- Shared footer -->
  <div id="site-footer"></div>

  <!-- Shared loaders + i18n -->
  <script src="/js/header-loader.js"></script>
  <script src="/js/footer-loader.js"></script>
  <script src="/js/lang.js"></script>

  <script>
    // Create Supabase client (local to this page)
    const SB = supabase.createClient(window.MEMOIR_SUPABASE_URL, window.MEMOIR_SUPABASE_ANON);

    // UI helpers
    const $ = (sel) => document.querySelector(sel);
    function show(id){ $(id).hidden = false; }
    function hide(id){ $(id).hidden = true; }
    function only(id){
      ['#signinCard','#registerCard','#resetRequestCard','#newPasswordCard'].forEach(s => hide(s));
      show(id);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 1) Sign-in
    (function(){
      const form   = $('#loginForm');
      const email  = $('#email');
      const pass   = $('#password');
      const err    = $('#loginError');
      const submit = $('#loginSubmit');

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        err.textContent = '';
        submit.disabled = true;
        try{
          const { error } = await SB.auth.signInWithPassword({
            email: email.value.trim(),
            password: pass.value
          });
          if (error) throw error;
          location.href = '/stories.html';
        }catch(ex){
          err.textContent = ex?.message || 'Sign in failed.';
        }finally{
          submit.disabled = false;
        }
      });
    })();

    // 2) Toggle Register & Reset panels
    $('#openRegister').addEventListener('click', ()=> only('#registerCard'));
    $('#closeRegister').addEventListener('click', ()=> only('#signinCard'));
    $('#openReset').addEventListener('click', ()=> only('#resetRequestCard'));
    $('#closeReset').addEventListener('click', ()=> only('#signinCard'));
    $('#closeNewPass').addEventListener('click', ()=> only('#signinCard'));

    // 3) Register (Create account)
    (function(){
      const form = $('#registerForm');
      const msg  = $('#registerMsg');

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        msg.style.color = '#444'; msg.textContent = 'Creating…';

        const name     = $('#reg_name').value.trim();
        const username = $('#reg_username').value.trim() || null;
        const email    = $('#reg_email').value.trim();
        const password = $('#reg_password').value;
        const plan     = $('#reg_plan').value;
        const consent  = $('#reg_gdpr').checked;
        if (!consent){ msg.style.color='#a33'; msg.textContent='Please accept Terms & Privacy.'; return; }

        try{
          const { error } = await SB.auth.signUp({
            email, password,
            options: {
              emailRedirectTo: location.origin + '/login.html',
              data: { name, username, subscription_plan: plan }
            }
          });
          if (error) throw error;
          msg.style.color = '#2d6a4f';
          msg.textContent = 'Account created. Please confirm via the email we sent you, then sign in.';
          setTimeout(()=> only('#signinCard'), 1200);
        }catch(ex){
          msg.style.color = '#a33';
          msg.textContent = ex?.message || 'Registration failed.';
        }
      });
    })();

    // 4) Request password reset (send email)
    (function(){
      const form = $('#resetRequestForm');
      const msg  = $('#resetMsg');
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        msg.style.color='#444'; msg.textContent='Sending reset email…';
        try{
          const email = $('#reset_email').value.trim();
          const { error } = await SB.auth.resetPasswordForEmail(email, {
            redirectTo: location.origin + '/login.html'
          });
          if (error) throw error;
          msg.style.color = '#2d6a4f';
          msg.textContent = 'Check your inbox for a reset link.';
        }catch(ex){
          msg.style.color = '#a33';
          msg.textContent = ex?.message || 'Could not send reset email.';
        }
      });
    })();

    // 5) If we arrive from the email link, show "Set new password"
    (async function(){
      // Supabase adds a recovery session when user arrives via the link
      const hash = location.hash || '';
      const isRecovery = hash.includes('type=recovery');
      if (isRecovery) only('#newPasswordCard');

      const form = $('#newPassForm');
      const msg  = $('#newPassMsg');
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        msg.style.color='#444'; msg.textContent='Updating…';
        try{
          const newPassword = $('#new_password').value;
          const { error } = await SB.auth.updateUser({ password: newPassword });
          if (error) throw error;
          msg.style.color='#2d6a4f';
          msg.textContent = 'Password updated. You can sign in now.';
          setTimeout(()=> only('#signinCard'), 800);
        }catch(ex){
          msg.style.color='#a33';
          msg.textContent = ex?.message || 'Could not update password.';
        }
      });
    })();
  </script>
</body>
</html>
