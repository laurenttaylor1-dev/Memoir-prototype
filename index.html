<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Memoir — Recorder</title>
<meta name="color-scheme" content="light dark"/>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--fg:#0f172a;--muted:#667085;--brand:#2563eb;--brand2:#7c3aed;--border:#e6e9f0}
  @media (prefers-color-scheme:dark){:root{--bg:#0b1020;--card:#0f162e;--fg:#e6edf7;--muted:#9aa4b2;--border:#1f2a44}}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1100px;margin:20px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px}
  header{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:34px;height:34px;border-radius:12px;background:conic-gradient(from 180deg,var(--brand),var(--brand2))}
  h1{margin:0;font-size:1.35rem}
  .controls{display:flex;gap:10px;flex-wrap:wrap}
  select,input,button{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:inherit}
  .btn{cursor:pointer}
  .muted{color:var(--muted)}
  #error{background:#fee2e2;color:#991b1b;border:1px solid #fecaca;border-radius:12px;padding:10px;display:none}
  #guard{margin:10px 0}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <h1>Memoir — Recorder</h1>
      </div>
      <div class="controls">
        <select id="lang">
          <option value="en">English</option>
          <option value="fr">Français</option>
          <option value="es">Español</option>
          <option value="nl">Nederlands</option>
        </select>
        <span id="planBadge">Plan: …</span>
        <input id="codeInput" placeholder="Enter trial code"/>
        <button id="redeemBtn" class="btn">Redeem</button>
        <button id="toggleLib" class="btn">☰ Library</button>
        <button id="helpBtn" class="btn">❓ Help</button>
        <button id="logout" class="btn">Logout</button>
      </div>
    </header>

    <div id="error"></div>
    <div id="guard" class="muted">Checking your session…</div>

    <div id="app" style="display:none">
      <p class="muted">Whisper chunked transcription enabled. EN/FR/ES/NL prompts + voice, library, AI rewrite, CSV, trials.</p>

      <!-- Your existing UI continues below … -->
      <div id="transcript" style="border:1px solid var(--border);border-radius:12px;padding:12px;min-height:140px">Your words will appear here…</div>
      <div style="display:flex;gap:10px;margin-top:10px">
        <button id="mic" class="btn">Record</button>
        <button id="save" class="btn">Save story</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1/dist/umd/supabase.js"></script>
<script>
(async function boot(){
  const ERR = msg => { const el=document.getElementById('error'); el.textContent=msg; el.style.display='block'; };
  const guard = document.getElementById('guard');
  const app   = document.getElementById('app');

  let supabase;
  try{
    const SUPABASE_URL = "https://jrjqciywlijhhcxfxywh.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpyanFjaXl3bGlqaGhjeGZ4eXdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MDQ2NzEsImV4cCI6MjA3MTA4MDY3MX0.5FeQxu_N7q-1Br00yJu4E-TKTZK4U4ZnJ4jpRo7Atak";
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth:{persistSession:true, autoRefreshToken:true, detectSessionInUrl:false}
    });
  }catch(e){
    ERR("Could not load Supabase SDK. Check your network or the <script> tag.");
    return;
  }

  let session=null;
  try{
    const { data:{ session: s }, error } = await supabase.auth.getSession();
    if(error) throw error;
    session = s;
  }catch(e){
    ERR("Auth check failed: " + (e.message||e));
    return;
  }

  if(!session){
    // No session → bounce to login
    window.location.replace('/login.html');
    return;
  }

  // If we’re here, user is signed in
  guard.style.display='none';
  app.style.display='block';

  // (Optional) show plan badge (safe if table empty due to RLS)
  try{
    const { data, error } = await supabase.from('profiles').select('plan, trial_end, role').single();
    if(!error && data){
      const badge = document.getElementById('planBadge');
      const trial = data.trial_end ? new Date(data.trial_end) : null;
      const trialActive = trial && Date.now() < trial.getTime();
      const isAdmin = data.role === 'admin';
      badge.textContent = isAdmin ? 'Plan: Admin' : trialActive ? `Plan: Premium (trial)` : `Plan: ${data.plan||'free'}`;
    }
  }catch{}

  // Simple recorder placeholder (UI won’t block app load)
  const mic = document.getElementById('mic');
  const transcript = document.getElementById('transcript');
  let rec=null, chunks=[], running=false;

  mic.onclick = async () => {
    if(running){ stop(); return; }
    try{
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : 'audio/webm';
      rec = new MediaRecorder(stream,{mimeType:mime, audioBitsPerSecond:96000});
      rec.ondataavailable = e => { if(e.data && e.data.size>0) chunks.push(e.data); };
      rec.onstop = async () => {
        if(!chunks.length) return;
        const blob = new Blob(chunks, {type:mime});
        chunks = [];
        try{
          const form = new FormData();
          form.append('audio', blob, 'chunk.webm');
          form.append('lang', document.getElementById('lang').value || 'fr');
          const r = await fetch('/api/transcribe-chunk', { method:'POST', body: form });
          const j = await r.json();
          if(j.text) transcript.textContent += (transcript.textContent.trim() ? ' ' : '') + j.text;
        }catch(e){ console.log('transcribe error', e); }
      };
      rec.start();
      running=true; mic.textContent='Stop';
    }catch(e){
      alert('Mic error: '+(e.message||e));
    }
  };

  function stop(){ try{rec && rec.state!=='inactive' && rec.stop();}catch{} running=false; mic.textContent='Record'; }

  document.getElementById('logout').onclick = async ()=>{
    await supabase.auth.signOut();
    location.href = '/login.html';
  };
})();
</script>
</body>
</html>
