<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Memoir — Recorder</title>
<meta name="color-scheme" content="light dark" />
<style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --fg:#0f172a; --muted:#667085;
  --brand:#2563eb; --brand2:#7c3aed; --border:#e6e9f0;
  --shadow:0 20px 40px rgba(2,8,23,.06), 0 2px 6px rgba(2,8,23,.04);
}
@media (prefers-color-scheme:dark){
  :root{ --bg:#0b1020; --card:#0f162e; --fg:#e6edf7; --muted:#9aa4b2; --border:#1f2a44; --shadow:0 20px 40px rgba(0,0,0,.4), 0 2px 6px rgba(0,0,0,.3) }
}
*,*:before,*:after{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:
    radial-gradient(1200px 600px at -10% -20%, rgba(124,58,237,.12), transparent 40%),
    radial-gradient(1200px 600px at 110% -10%, rgba(37,99,235,.12), transparent 40%),
    var(--bg);
  color:var(--fg);
}
.container{max-width:980px;margin:0 auto;padding:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:20px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:36px;height:36px;border-radius:12px;background:conic-gradient(from 180deg at 50% 50%, var(--brand), var(--brand2)); box-shadow:0 6px 18px rgba(37,99,235,.35)}
h1{margin:0;font-size:clamp(1.3rem,1.2rem+1.2vw,1.8rem)}

.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
select,.btn{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:inherit}
.btn{cursor:pointer}

.shell{display:grid;gap:20px;grid-template-columns:1fr}
.left,.right{min-width:0}
.right{display:none}
@media (min-width:1024px){
  .shell{grid-template-columns:minmax(0,1fr) 360px}
  .right{display:block}
}

.label{font-size:12px;font-weight:700;text-transform:uppercase;color:var(--muted);letter-spacing:.08em;margin:10px 0 6px}

.segment{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:transparent}
.tab.active{background:rgba(37,99,235,.1);border-color:rgba(37,99,235,.25)}

.prompt-row{display:flex;gap:8px;flex-wrap:wrap}
.chip{padding:10px 12px;border-radius:999px;background:rgba(37,99,235,.08);border:1px solid rgba(37,99,235,.18);white-space:nowrap;cursor:pointer}

input[type="text"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:rgba(2,8,23,.02)}
.area{min-height:180px;border:1px solid var(--border);border-radius:12px;padding:14px;background:rgba(2,8,23,.02)}

.mic-wrap{display:flex;flex-direction:column;align-items:center;gap:12px;margin:12px 0}
.mic{
  width:190px;height:190px;border-radius:999px;border:0;color:#fff;font-weight:700;font-size:20px;cursor:pointer;
  background:linear-gradient(160deg, var(--brand), var(--brand2));
  box-shadow:0 20px 44px rgba(37,99,235,.35), 0 4px 10px rgba(2,8,23,.12); position:relative;
}
.mic.pulse::after{content:"";position:absolute;inset:-8px;border-radius:999px;background:radial-gradient(closest-side, rgba(124,58,237,.25), transparent 70%);animation:pulse 1.6s infinite ease-in-out}
@keyframes pulse{0%{transform:scale(1);opacity:.9}70%{transform:scale(1.08);opacity:0}100%{transform:scale(1.12);opacity:0}}

.meter{display:flex;gap:8px;align-items:center;width:100%;max-width:420px}
.bar{flex:1;height:10px;background:rgba(2,8,23,.08);border-radius:999px;overflow:hidden}
.bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--brand),var(--brand2))}
.muted{color:var(--muted);font-size:12px}

.actions{display:flex;gap:10px;flex-wrap:wrap}
.btn.primary{background:linear-gradient(90deg,var(--brand),var(--brand2)); color:#fff; border:0}

.list{display:grid;gap:14px}
.story{padding:14px;border:1px solid var(--border);border-radius:12px;background:rgba(2,8,23,.02)}
.story header{display:flex;justify-content:space-between;align-items:flex-start;margin:0 0 6px 0}
.story h3{margin:0;font-size:16px}
.story .time{font-size:12px;color:var(--muted)}

.drawer{position:fixed;inset:0;display:none;background:rgba(2,8,23,.45);backdrop-filter: blur(2px)}
.drawer.show{display:block}
.drawer .panel{position:absolute;right:0;top:0;bottom:0;width:88%;max-width:420px;background:var(--card);border-left:1px solid var(--border);padding:16px;overflow:auto}

footer{margin:22px 0;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <h1>Memoir — Recorder</h1>
        </div>
        <div class="controls">
          <select id="lang" aria-label="Language">
            <option value="en">English</option>
            <option value="fr">Français</option>
          </select>
          <select id="plan" aria-label="Plan">
            <option value="free">Free (2 min)</option>
            <option value="pro">Pro (longer)</option>
          </select>
          <button id="toggleLib" class="btn">☰ Library</button>
        </div>
      </header>

      <div class="shell">
        <section class="left">
          <div class="label">Mode</div>
          <div class="segment">
            <button id="tabGuided" class="tab active">Guided</button>
            <button id="tabFree" class="tab">Free</button>
          </div>

          <div id="guidedBlock">
            <div class="label">Suggested topics</div>
            <div id="prompts" class="prompt-row"></div>
          </div>

          <div class="label">Title</div>
          <input id="title" type="text" placeholder="Story title (optional)" />

          <div class="label">Transcript</div>
          <div id="transcript" class="area" aria-live="polite">Your words will appear here…</div>

          <div class="mic-wrap">
            <button id="mic" class="mic" aria-pressed="false">Record</button>
            <div class="meter" id="meter" style="display:none">
              <div class="bar"><div id="bar"></div></div>
              <div id="remain" class="muted">120s</div>
            </div>
            <div id="asr" class="muted">Transcribing…</div>
          </div>

          <div class="actions">
            <button id="save" class="btn primary" disabled>Save story</button>
            <button id="clear" class="btn">Clear</button>
          </div>
        </section>

        <aside class="right">
          <div class="label">Library</div>
          <div id="library" class="list"></div>
        </aside>
      </div>

      <footer>Prototype: memoir recorder — EN/FR, 2‑minute cap on Free.</footer>
    </div>
  </div>

  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="label" style="margin:0">Library</div>
        <button id="closeDrawer" class="btn">Close</button>
      </div>
      <div id="libraryDrawer" class="list"></div>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const lang=$('lang'), plan=$('plan');
  const promptsEl=$('prompts'), titleEl=$('title'), transcriptEl=$('transcript');
  const mic=$('mic'), meter=$('meter'), bar=$('bar'), remain=$('remain'), asr=$('asr');
  const save=$('save'), clearBtn=$('clear'), library=$('library');
  const drawer=$('drawer'), libraryDrawer=$('libraryDrawer');
  const toggleLib=$('toggleLib'), closeDrawer=$('closeDrawer');
  const tabGuided=$('tabGuided'), tabFree=$('tabFree'), guidedBlock=$('guidedBlock');

  let locale = navigator.language?.startsWith('fr') ? 'fr' : 'en';
  lang.value = locale;
  let tier = 'free'; plan.value = tier;
  let cap = tier==='free'?120:3600;
  let mode = 'guided';
  let transcript = '', selectedPrompt='', elapsed=0, timer=null;
  let recognition=null, rec=null, stream=null, chunks=[], audioBlob=null;

  const promptsEN=[ "Describe your home growing up.","Tell me about your first job.","How did you meet your partner?","What big events did you live through?","What advice would you give your 20-year-old self?" ];
  const promptsFR=[ "Décrivez votre maison quand vous étiez enfant.","Parlez de votre premier emploi.","Comment avez-vous rencontré votre partenaire ?","Quels grands événements avez-vous vécus ?","Quel conseil donneriez-vous à vos 20 ans ?" ];

  // Render topic chips
  function renderPrompts(){
    promptsEl.innerHTML='';
    (locale==='fr'?promptsFR:promptsEN).forEach(p=>{
      const b=document.createElement('button');
      b.className='chip'; b.textContent=p; b.onclick=()=>selectedPrompt=p;
      promptsEl.appendChild(b);
    });
  }

  // Library (responsive + drawer)
  function renderLib(){
    const target=(window.innerWidth>=1024)?library:libraryDrawer;
    target.innerHTML='';
    let items=[]; try{items=JSON.parse(localStorage.getItem('memoir_stories')||'[]')}catch{}
    if(!items.length){ const p=document.createElement('p'); p.className='muted'; p.textContent=(locale==='fr'?'Aucune histoire pour le moment.':'No stories yet.'); target.appendChild(p); return; }
    for(const s of items){
      const el=document.createElement('div'); el.className='story';
      const head=document.createElement('header');
      const h3=document.createElement('h3'); h3.textContent=s.title;
      const time=document.createElement('div'); time.className='time'; time.textContent=new Date(s.createdAt).toLocaleString();
      head.appendChild(h3); head.appendChild(time); el.appendChild(head);
      const body=document.createElement('div'); body.textContent=s.transcript; el.appendChild(body);
      if(s.audioURL){ const aud=document.createElement('audio'); aud.controls=true; aud.src=s.audioURL; el.appendChild(aud); }
      const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='8px';
      const rewrite=document.createElement('button'); rewrite.className='btn'; rewrite.textContent=(locale==='fr'?'Réécrire (IA)':'Rewrite (AI)'); rewrite.onclick=()=>rewriteAI(s);
      const del=document.createElement('button'); del.className='btn'; del.textContent=(locale==='fr'?'Supprimer':'Delete'); del.onclick=()=>{ const next=(JSON.parse(localStorage.getItem('memoir_stories')||'[]')).filter(x=>x.id!==s.id); localStorage.setItem('memoir_stories', JSON.stringify(next)); renderLib(); };
      actions.appendChild(rewrite); actions.appendChild(del); el.appendChild(actions);
      target.appendChild(el);
    }
  }

  toggleLib.onclick=()=>{ if(window.innerWidth>=1024){ window.scrollTo({top:0,behavior:'smooth'}) } else { drawer.classList.add('show'); renderLib(); } };
  closeDrawer.onclick=()=>drawer.classList.remove('show');
  drawer.addEventListener('click',(e)=>{ if(e.target===drawer) drawer.classList.remove('show') });

  // Tabs
  tabGuided.onclick=()=>{ mode='guided'; tabGuided.classList.add('active'); tabFree.classList.remove('active'); guidedBlock.style.display='block'; };
  tabFree.onclick=()=>{ mode='free'; tabFree.classList.add('active'); tabGuided.classList.remove('active'); guidedBlock.style.display='none'; };

  // Clear
  clearBtn.onclick=()=>{ transcript=''; transcriptEl.textContent='Your words will appear here…'; titleEl.value=''; save.disabled=true; };

  // Record button
  mic.onclick = async ()=>{ if(rec && rec.state!=='inactive'){ stopAll(); } else { await startAll(); } };

  async function startAll(){
    transcript=''; transcriptEl.textContent=''; elapsed=0; remain.textContent = cap+'s'; bar.style.width='0%';
    try{
      stream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true}});
    }catch(e){
      alert('Microphone permission denied. Check site settings.'); return;
    }

    // MediaRecorder (cross-browser)
    chunks=[]; audioBlob=null; rec=null;
    try{
      if(window.MediaRecorder){
        const prefs=['audio/webm;codecs=opus','audio/webm','audio/mp4;codecs=mp4a.40.2','audio/mp4','audio/ogg;codecs=opus'];
        let mime=''; for(const t of prefs){ if(MediaRecorder.isTypeSupported?.(t)){ mime=t; break; } }
        rec=new MediaRecorder(stream, mime?{mimeType:mime}:{});
        rec.ondataavailable=(e)=>{ if(e.data?.size) chunks.push(e.data); };
        rec.onstop=()=>{ try{stream.getTracks().forEach(t=>t.stop());}catch{} const type=mime||(chunks[0]?.type||'audio/mp4'); audioBlob=chunks.length?new Blob(chunks,{type}):null; };
        rec.start();
      }
    }catch{ rec=null; }

    // Speech recognition
    const SR = window.webkitSpeechRecognition || window.SpeechRecognition;
    if(SR){
      recognition=new SR(); recognition.lang=(locale==='fr')?'fr-FR':'en-US'; recognition.continuous=true; recognition.interimResults=true;
      let full=''; recognition.onresult=(e)=>{ let inter=''; for(let i=e.resultIndex;i<e.results.length;i++){const r=e.results[i]; if(r.isFinal) full+=r[0].transcript+' '; else inter+=r[0].transcript;} transcript=(full+inter).trim(); transcriptEl.textContent=transcript; save.disabled=!transcript; };
      recognition.onerror=()=>{ asr.textContent='Speech recognition unavailable'; };
      try{ recognition.start(); asr.textContent='Transcribing…'; }catch{}
    } else { asr.textContent='Speech recognition is not available in this browser.'; }

    mic.textContent='Stop Recording'; mic.classList.add('pulse'); meter.style.display='flex';
    timer=setInterval(()=>{ elapsed++; bar.style.width=(elapsed/cap*100)+'%'; remain.textContent=Math.max(0,cap-elapsed)+'s'; if(elapsed>=cap) stopAll(); },1000);
  }

  function stopAll(){
    if(rec && rec.state!=='inactive'){ rec.stop(); }
    if(recognition){ try{ recognition.stop(); }catch{} }
    if(timer){ clearInterval(timer); timer=null; }
    mic.textContent='Record'; mic.classList.remove('pulse');
  }

  // Save
  save.onclick=()=>{
    const audioURL = audioBlob ? URL.createObjectURL(audioBlob) : undefined;
    const item = { id:Math.random().toString(36).slice(2), createdAt:Date.now(), title:titleEl.value||'Story', mode, prompt:mode==='guided'?selectedPrompt:undefined, transcript, audioURL, durationSec:elapsed };
    const prev=JSON.parse(localStorage.getItem('memoir_stories')||'[]'); prev.unshift(item); localStorage.setItem('memoir_stories', JSON.stringify(prev));
    renderLib(); clearBtn.onclick();
  };

  // Fixed‑style Ghostwriter
  async function rewriteAI(s){
    const tone="warm, vivid, cohesive"; const language=(lang.value==='fr')?'fr':'en';
    try{
      const res = await fetch('/api/rewrite',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:s.transcript,title:s.title,language,tone})});
      if(!res.ok){ const txt=await res.text(); alert('Error rewriting story.\n\n'+txt); return; }
      const data=await res.json(); const rewritten=data.text||'(no text)';
      const w=window.open('','_blank'); w.document.write(`<pre style="white-space:pre-wrap;font-family:system-ui;padding:16px">${rewritten.replace(/[<&>]/g,(c)=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]))}</pre>`); w.document.close();
    }catch(e){ alert('Rewrite error: '+(e?.message||e)); }
  }

  // Init
  renderPrompts(); renderLib();
  window.addEventListener('resize',renderLib);
})();
</script>
</body>
</html>
