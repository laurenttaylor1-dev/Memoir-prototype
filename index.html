<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Memoir — Recorder</title>
<meta name="color-scheme" content="light dark"/>
<style>
:root{--bg:#f6f7fb;--card:#fff;--fg:#0f172a;--muted:#667085;--brand:#2563eb;--brand2:#7c3aed;--border:#e6e9f0;--shadow:0 20px 40px rgba(2,8,23,.06), 0 2px 6px rgba(2,8,23,.04)}
@media (prefers-color-scheme:dark){
  :root{--bg:#0b1020;--card:#0f162e;--fg:#e6edf7;--muted:#9aa4b2;--border:#1f2a44;--shadow:0 20px 40px rgba(0,0,0,.4),0 2px 6px rgba(0,0,0,.3)}
}
*,*:before,*:after{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.container{max-width:1100px;margin:0 auto;padding:20px}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:16px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px;flex-wrap:wrap}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:34px;height:34px;border-radius:12px;background:conic-gradient(from 180deg,var(--brand),var(--brand2))}
h1{margin:0;font-size:1.35rem}
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
select,input,button{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:inherit}
.btn{cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--brand),var(--brand2));border:0;color:#fff}
.badge{border-radius:999px}
.muted{color:var(--muted);font-size:12px}
.lock{opacity:.6; cursor:not-allowed}

.shell{display:grid;gap:18px;grid-template-columns:1fr}
.right{display:none}
@media (min-width:1024px){ .shell{grid-template-columns:minmax(0,1fr) 420px}.right{display:block} }

.segment{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:transparent}
.tab.active{background:rgba(37,99,235,.12);border-color:rgba(37,99,235,.25)}
.small{font-size:12px;color:var(--muted)}

.label{font-size:12px;font-weight:700;text-transform:uppercase;color:var(--muted);letter-spacing:.08em;margin:10px 0 6px}
.topics{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
.chip{display:flex;align-items:center;justify-content:center;height:44px;border-radius:12px;border:1px solid rgba(37,99,235,.18);background:rgba(37,99,235,.08);font-weight:600;cursor:pointer;user-select:none}
.chip:active{transform:translateY(1px)}

.area{min-height:160px;border:1px solid var(--border);border-radius:12px;padding:12px;background:rgba(2,8,23,.02)}
.mic-wrap{display:flex;flex-direction:column;align-items:center;gap:10px;margin:12px 0}
.mic{width:190px;height:190px;border-radius:999px;border:0;background:radial-gradient(70% 70% at 50% 30%, #ff5a5f, #a21caf);color:#fff;font-weight:700;font-size:18px;cursor:pointer;box-shadow:0 16px 50px rgba(162,28,175,.35)}
.mic.pulse{animation:pulse 1.6s infinite ease-in-out}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.04)}100%{transform:scale(1)}}
.meter{display:flex;gap:8px;align-items:center;width:100%;max-width:420px}
.bar{flex:1;height:10px;background:rgba(2,8,23,.08);border-radius:999px;overflow:hidden}
.bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--brand),var(--brand2))}

.list{display:grid;gap:10px}
.story{padding:12px;border:1px solid var(--border);border-radius:12px;background:rgba(2,8,23,.02);display:flex;align-items:center;justify-content:space-between;gap:8px}
.story h3{margin:0;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}

.drawer{position:fixed;inset:0;display:none;background:rgba(2,8,23,.45);backdrop-filter: blur(2px)}
.drawer.show{display:block}
.drawer .panel{position:absolute;right:0;top:0;bottom:0;width:88%;max-width:420px;background:var(--card);border-left:1px solid var(--border);padding:16px;overflow:auto}
dialog::backdrop{background:rgba(0,0,0,.35)}
dialog{border:none;border-radius:12px;box-shadow:var(--shadow);max-width:min(820px,92vw)}
footer{margin:20px 0 8px;text-align:center;color:var(--muted);font-size:12px}
.badgePlan{padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px}
.input{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:inherit;width:100%}
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <h1>Memoir — Recorder</h1>
        </div>
        <div class="controls">
          <select id="lang" aria-label="Language">
            <option value="en">English</option>
            <option value="fr">Français</option>
            <option value="es">Español</option>
            <option value="nl">Nederlands</option>
          </select>
          <span id="planBadge" class="badgePlan">Plan: …</span>
          <div id="redeemBox" style="display:flex; gap:8px; align-items:center;">
            <input id="codeInput" type="text" placeholder="Enter trial code" class="input" style="max-width:200px">
            <button id="redeemBtn" class="btn">Redeem</button>
            <span id="redeemMsg" class="muted"></span>
          </div>
          <button id="toggleLib" class="btn">☰ Library</button>
          <button id="helpBtn" class="btn">❓ Help</button>
          <button id="logout" class="btn badge">Logout</button>
        </div>
      </header>

      <div id="guard" class="muted" style="margin:6px 0 14px">Checking your session…</div>

      <div id="app" class="shell" style="display:none">
        <section class="left">
          <div class="segment">
            <button id="tabGuided" class="tab active">Guided</button>
            <button id="tabFree" class="tab">Free</button>
          </div>

          <div id="guidedBlock">
            <div class="label">Suggested topics</div>
            <div id="prompts" class="topics"></div>
            <div class="small">Tip: tapping a topic speaks a gentle question in your selected language.</div>
          </div>

          <div class="label">Title</div>
          <input id="title" type="text" class="input" placeholder="Story title (optional)" />

          <div class="label">When did this happen?</div>
          <input id="when" type="text" class="input" placeholder='e.g., "summer 1945", "early 2018", "15 Feb 1972"' />

          <div class="label">Transcript</div>
          <div id="transcript" class="area" aria-live="polite">Your words will appear here…</div>

          <div class="mic-wrap">
            <button id="mic" class="mic" aria-pressed="false">Record</button>
            <div class="meter" id="meter" style="display:none">
              <div class="bar"><div id="bar"></div></div>
              <div id="remain" class="muted">120s</div>
            </div>
            <div id="asr" class="muted"></div>
          </div>

          <div class="actions" style="display:flex;gap:10px;flex-wrap:wrap">
            <button id="save" class="btn primary" disabled>Save story</button>
            <button id="clear" class="btn">Clear</button>
            <button id="exportBook" class="btn lock" title="Premium only" disabled>Export Book (PDF)</button>
            <button id="exportCsv" class="btn">Export CSV</button>
          </div>
        </section>

        <aside class="right">
          <div class="label">Library</div>
          <div id="library" class="list"></div>
        </aside>
      </div>

      <footer>Cloud prototype — Whisper transcription default. EN/FR/ES/NL prompts + voice, library, AI rewrite, CSV, trials.</footer>
    </div>
  </div>

  <!-- Mobile drawer -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="label" style="margin:0">Library</div>
        <button id="closeDrawer" class="btn">Close</button>
      </div>
      <div id="libraryDrawer" class="list"></div>
    </div>
  </div>

  <!-- Help / FAQ dialog -->
  <dialog id="faqDialog">
    <form method="dialog" style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #e5e7eb">
      <strong id="faqTitle">Help / FAQ</strong>
      <button class="btn" autofocus>Close</button>
    </form>
    <div id="faqBody" style="padding:16px;max-width:min(820px,92vw)"></div>
  </dialog>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1/dist/umd/supabase.js"></script>

<script>
(async function(){
  /* ===== Supabase session guard ===== */
  const SUPABASE_URL = "https://jrjqciywlijhhcxfxywh.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpyanFjaXl3bGlqaGhjeGZ4eXdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MDQ2NzEsImV4cCI6MjA3MTA4MDY3MX0.5FeQxu_N7q-1Br00yJu4E-TKTZK4U4ZnJ4jpRo7Atak";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:false} });

  const guard=document.getElementById('guard'), app=document.getElementById('app');
  const { data:{session} } = await supabase.auth.getSession();
  if(!session){ window.location.replace('/login.html'); return; }

  // Load plan / role
  const { data: profile } = await supabase.from('profiles').select('plan, trial_end, role').single();
  const trialUntil = profile?.trial_end ? new Date(profile.trial_end) : null;
  const trialActive = trialUntil && Date.now() < trialUntil.getTime();
  const isAdmin = profile?.role === 'admin';
  let isPremium = isAdmin || profile?.plan === 'premium' || trialActive;

  guard.style.display='none'; app.style.display='grid';
  document.getElementById('logout').onclick = async ()=>{ await supabase.auth.signOut(); window.location.replace('/login.html'); };

  // Plan badge
  const planBadge = document.getElementById('planBadge');
  if (isAdmin) {
    planBadge.textContent = 'Plan: Admin';
  } else if (isPremium) {
    planBadge.textContent = trialActive
      ? `Plan: Premium (trial until ${trialUntil.toLocaleDateString()})`
      : 'Plan: Premium';
  } else {
    planBadge.textContent = 'Plan: Free';
  }

  /* ===== Redeem code UI ===== */
  const codeInput = document.getElementById('codeInput');
  const redeemBtn = document.getElementById('redeemBtn');
  const redeemMsg = document.getElementById('redeemMsg');
  const setRedeemMsg = (t)=>{ if(redeemMsg) redeemMsg.textContent = t || ''; };
  redeemBtn?.addEventListener('click', async () => {
    setRedeemMsg('');
    const code = codeInput.value.trim();
    if(!code) { setRedeemMsg('Enter a code.'); return; }
    const { data: { user } } = await supabase.auth.getUser();
    if(!user){ setRedeemMsg('Please sign in first.'); return; }
    try{
      const { data, error } = await supabase.rpc('redeem_code', { p_code: code });
      if (error) throw error;
      if (data?.ok) { setRedeemMsg(`✅ Premium until ${new Date(data.trial_end).toLocaleDateString()}`); location.reload(); }
      else {
        const map={not_authenticated:'Please sign in first.',not_found:'Code not found.',expired:'Code expired.',exhausted:'Code already used.',already_premium:'You already have Premium.'};
        setRedeemMsg('❌ ' + (map[data?.error] || 'Redeem failed.'));
      }
    }catch(e){ setRedeemMsg('❌ ' + (e.message || String(e))); }
  });

  /* ===== DOM ===== */
  const $=id=>document.getElementById(id);
  const lang=$('lang'), promptsWrap=$('prompts');
  const titleEl=$('title'), whenEl=$('when'), transcriptEl=$('transcript');
  const mic=$('mic'), meter=$('meter'), bar=$('bar'), remain=$('remain'), asr=$('asr');
  const save=$('save'), clearBtn=$('clear'), library=$('library');
  const drawer=$('drawer'), libraryDrawer=$('libraryDrawer'), toggleLib=$('toggleLib'), closeDrawer=$('closeDrawer');
  const tabGuided=$('tabGuided'), tabFree=$('tabFree'), guidedBlock=$('guidedBlock');
  const exportBookBtn=$('exportBook'), exportCsvBtn=$('exportCsv');

  // Gating
  function setPremiumUI(enabled){
    const lockBtn = (btn, on, title) => {
      btn.toggleAttribute('disabled', !on);
      btn.classList.toggle('lock', !on);
      if (!on && title) btn.title = title; else btn.removeAttribute('title');
    };
    lockBtn(exportBookBtn, enabled, 'Premium only');
  }
  setPremiumUI(isPremium);

  const CAP_FREE = 120;      // seconds
  const CAP_PREM = 900;
  const getCap = () => (isPremium ? CAP_PREM : CAP_FREE);
  const BCP={en:'en',fr:'fr',es:'es',nl:'nl'}; // we pass ISO hint to backend

  /* ===== Topics + Spoken prompts (same) ===== */
  const TOPIC_WORDS = {
    en:["Childhood","Family","School","Work","Love","War","Travel","Traditions","Holidays","Lessons","Advice","Turning-points"],
    fr:["Enfance","Famille","École","Travail","Amour","Guerre","Voyages","Traditions","Fêtes","Leçons","Conseils","Déclics"],
    es:["Infancia","Familia","Escuela","Trabajo","Amor","Guerra","Viajes","Tradiciones","Fiestas","Lecciones","Consejos","Puntos-clave"],
    nl:["Jeugd","Familie","School","Werk","Liefde","Oorlog","Reizen","Tradities","Feestdagen","Lessen","Advies","Keerpunt"]
  };
  const PROMPT_SENTENCES = {
    en:{Childhood:"Tell me something about your youth.",Family:"Tell me about your family and the people who raised you.",School:"What was school like for you?",Work:"Tell me about your first job or career.",Love:"How did you meet your partner, or what did love mean to you then?",War:"What big world events or conflicts did you live through?",Travel:"Where did you travel that left a mark on you?",Traditions:"Which family traditions mattered most to you?",Holidays:"Describe a holiday you remember vividly.",Lessons:"What life lesson did you learn the hard way?",Advice:"What advice would you give your younger self?","Turning-points":"What was a turning point that changed your path?"},
    fr:{Enfance:"Parlez-moi de votre jeunesse, d’un souvenir marquant.",Famille:"Parlez-moi de votre famille et des personnes qui vous ont élevé.",École:"Comment était l’école pour vous ?",Travail:"Racontez-moi votre premier travail ou votre carrière.",Amour:"Comment avez-vous rencontré votre partenaire, et que signifiait l’amour pour vous ?",Guerre:"Quels grands événements ou conflits avez-vous vécus ?",Voyages:"Quels voyages vous ont marqué(e) ?",Traditions:"Quelles traditions familiales comptaient le plus ?",Fêtes:"Décrivez une fête dont vous vous souvenez clairement.",Leçons:"Quelle leçon de vie avez-vous apprise à la dure ?",Conseils:"Quel conseil donneriez-vous à votre jeune vous ?",Déclics:"Quel déclic a changé votre trajectoire ?"},
    es:{Infancia:"Cuéntame algo sobre tu juventud.",Familia:"Háblame de tu familia y de quienes te criaron.",Escuela:"¿Cómo era la escuela para ti?",Trabajo:"Cuéntame sobre tu primer trabajo o tu carrera.",Amor:"¿Cómo conociste a tu pareja y qué significaba el amor entonces?",Guerra:"¿Qué grandes eventos o conflictos viviste?",Viajes:"¿Qué viajes te marcaron?",Tradiciones:"¿Qué tradiciones familiares eran importantes para ti?",Fiestas:"Describe una fiesta que recuerdes con claridad.",Lecciones:"¿Qué lección de vida aprendiste con dificultad?",Consejos:"¿Qué consejo le darías a tu yo joven?","Puntos-clave":"¿Cuál fue un punto de inflexión en tu vida?"},
    nl:{Jeugd:"Vertel me iets over je jeugd.",Familie:"Vertel over je familie en de mensen die je hebben opgevoed.",School:"Hoe was school voor jou?",Werk:"Vertel over je eerste baan of je loopbaan.",Liefde:"Hoe heb je je partner ontmoet, en wat betekende liefde toen?",Oorlog:"Welke grote gebeurtenissen of conflicten heb je meegemaakt?",Reizen:"Welke reizen hebben indruk op je gemaakt?",Tradities:"Welke familietradities waren belangrijk voor je?",Feestdagen:"Beschrijf een feestdag die je helder herinnert.",Lessen:"Welke levensles heb je op de harde manier geleerd?",Advies:"Welk advies zou je je jongere zelf geven?",Keerpunt:"Wat was een keerpunt in je leven?"}
  };

  /* ===== ElevenLabs TTS for prompts (unchanged) ===== */
  const VOICE_BY_LANG = { en:'KoVIHoyLDrQyd4pGalbs', fr:'TfGtrgcVrXWjJkeB51T1', nl:'yO6w2xlECAQRFP6pX7Hw', es:'ZpEtuMdTIlJXYXAhevhG' };
  async function speakViaElevenLabs(sentence, code){
    try{
      const r = await fetch('/api/voice', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text: sentence, voiceId: VOICE_BY_LANG[code] || VOICE_BY_LANG.en }) });
      if(!r.ok) throw new Error('tts_failed');
      const blob = await r.blob(); const url = URL.createObjectURL(blob); const audio = new Audio(url); await audio.play(); setTimeout(()=>URL.revokeObjectURL(url), 60000);
      return true;
    }catch(e){ console.warn('ElevenLabs TTS failed → fallback', e); return false; }
  }
  function speakSystem(sentence, code){
    if(!('speechSynthesis' in window)) return;
    const u=new SpeechSynthesisUtterance(String(sentence)); u.lang=(code||'en'); u.rate=.95; u.pitch=1; u.volume=1; speechSynthesis.cancel(); speechSynthesis.speak(u);
  }
  async function speakPrompt(oneWord, code){
    const sentence=(PROMPT_SENTENCES[code]||{})[oneWord] || oneWord;
    const ok = await speakViaElevenLabs(sentence, code);
    if(!ok) speakSystem(sentence, code);
  }
  function renderPrompts(){
    const code=lang.value; promptsWrap.innerHTML='';
    (TOPIC_WORDS[code]||TOPIC_WORDS.en).forEach(word=>{
      const chip=document.createElement('div'); chip.className='chip'; chip.textContent=word;
      chip.onclick=()=>{ titleEl.value=word; speakPrompt(word, code); };
      promptsWrap.appendChild(chip);
    });
  }

  /* ===== Library / helpers (unchanged) ===== */
  const LSKEY='memoir.stories';
  const loadStories=()=>{try{return JSON.parse(localStorage.getItem(LSKEY)||'[]')}catch{return[]}};
  const saveStories=(list)=>localStorage.setItem(LSKEY,JSON.stringify(list));
  const esc=s=>String(s).replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  function storyRow(s, idx){
    const row=document.createElement('div'); row.className='story';
    const meta=document.createElement('div'); meta.style.minWidth='0';
    const h=document.createElement('h3'); h.textContent=s.title||'Story';
    const t=document.createElement('div'); t.className='muted';
    t.textContent= s.happened_label || (s.happened_sort?new Date(s.happened_sort).toDateString():new Date(s.created).toLocaleString());
    meta.appendChild(h); meta.appendChild(t);
    const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.flexWrap='wrap';
    const make=(txt,fn,disabled)=>{const b=document.createElement('button'); b.className='btn'; b.textContent=txt; if(disabled){ b.disabled=true; b.classList.add('lock'); } b.onclick=fn; return b;};
    actions.appendChild(make('View',()=>viewStory(s)));
    actions.appendChild(make('Rewrite (AI)',()=>requirePremium() && rewriteAI(idx), !(isPremium)));
    actions.appendChild(make('Undo',()=>undoRewrite(idx), !s.prev));
    actions.appendChild(make('Download .docx',()=>downloadDocx(s)));
    actions.appendChild(make('Delete',()=>delStory(idx)));
    row.appendChild(meta); row.appendChild(actions);
    return row;
  }
  function renderLib(toDrawer=false){
    const items=loadStories(); const tgt = toDrawer?libraryDrawer:library;
    tgt.innerHTML=''; if(!items.length){ const p=document.createElement('p'); p.className='muted'; p.textContent='No stories yet.'; tgt.appendChild(p); return; }
    items.forEach((s,i)=>tgt.appendChild(storyRow(s,i)));
  }
  function requirePremium(){ if(!isPremium){ alert('This is a Premium feature. Enter a valid code for a 14‑day trial.'); return false; } return true; }
  function viewStory(s){
    const dlg=document.createElement('dialog');
    dlg.style.width='min(90vw,820px)';
    dlg.innerHTML=`<form method="dialog" style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #e5e7eb"><strong>${esc(s.title||'Story')}</strong><button autofocus class="btn">Close</button></form><div style="padding:16px"><div class="muted" style="margin-bottom:6px">${esc(s.happened_label || (s.happened_sort?new Date(s.happened_sort).toDateString():new Date(s.created).toLocaleString()))}</div><div style="white-space:pre-wrap;font-family:system-ui">${esc(s.text||'')}</div></div>`;
    document.body.appendChild(dlg); dlg.addEventListener('close',()=>dlg.remove()); dlg.showModal();
  }
  function delStory(idx){ if(!confirm('Delete this story?')) return; const items=loadStories(); items.splice(idx,1); saveStories(items); renderLib(innerWidth<1024); }
  function undoRewrite(idx){ const items=loadStories(); const s=items[idx]; if(!s?.prev) return alert('No previous version stored.'); s.text=s.prev; delete s.prev; saveStories(items); renderLib(innerWidth<1024); }
  async function rewriteAI(idx){
    const items=loadStories(); const s=items[idx]; if(!s) return;
    const payload = { text: s.text, style: "warm, vivid, cohesive autobiography with gentle pacing and sensory details", lang: lang.value || 'en' };
    const r = await fetch('/api/rewrite', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!r.ok){ alert('Rewrite failed.'); return; }
    const data = await r.json(); s.prev = s.text; s.text = data.text || s.text; s.rewritten_at = new Date().toISOString();
    saveStories(items); renderLib(innerWidth<1024);
  }
  function downloadDocx(s){
    const zip = new JSZip();
    const meta = `Title: ${s.title||'Story'}\nWhen: ${s.happened_label || s.happened_sort || ''}\nCreated: ${new Date(s.created).toLocaleString()}\n\n`;
    zip.file('story.txt', meta + (s.text||'')); zip.generateAsync({type:'blob'}).then(blob=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(s.title||'story')+'.zip'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); });
  }

  exportCsvBtn.onclick=()=>{
    const items=loadStories();
    const rows=[['title','happened_label','happened_sort','created','text']];
    items.forEach(s=>rows.push([s.title||'',s.happened_label||'',s.happened_sort||'',s.created||'',(s.text||'').replace(/\n/g,'\\n')]));
    const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='memoir_stories.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
  };
  exportBookBtn.onclick=()=>{ if(!requirePremium()) return; alert('PDF export placeholder — Canva/real PDF pipeline coming.'); };

  /* ===== Approx date ===== */
  function parseApproxDate(input){
    if(!input) return { label:'', sort:null };
    const s=input.trim().toLowerCase();
    const iso=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/); if(iso){const d=new Date(+iso[1],+iso[2]-1,+iso[3]);return{label:input,sort:d.toISOString().slice(0,10)};}
    const yOnly=s.match(/(\d{4})/); if(yOnly){const d=new Date(+yOnly[1],0,1);return{label:input,sort:d.toISOString().slice(0,10)};}
    const season=s.match(/^(early|mid|late)?\s*(spring|summer|autumn|fall|winter)\s+(\d{4})$/);
    if(season){const y=+season[3];const base={spring:2,summer:5,autumn:8,fall:8,winter:11}[season[2]];let m=base,day=1;if(season[1]==='mid')day=10;if(season[1]==='late')day=20;const d=new Date(y,m,day);return{label:input,sort:d.toISOString().slice(0,10)};}
    return { label:input, sort:null };
  }

  /* ===== RECORDING WITH MEDIARECORDER → WHISPER ===== */
  let mediaRecorder=null, recChunks=[], recActive=false, elapsed=0, timer=null;

  async function startRec(){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation:true, noiseSuppression:true } });
      // Use a common Opus container that Whisper accepts
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
    }catch(e){
      asr.textContent = 'Mic permission denied or unsupported.';
      return;
    }

    recChunks = [];
    mediaRecorder.ondataavailable = (e)=>{ if(e.data && e.data.size) recChunks.push(e.data); };
    mediaRecorder.onstop = async ()=>{ await finalizeTranscription(); };

    asr.textContent='Recording…';
    mic.textContent='Stop Recording'; mic.classList.add('pulse');
    elapsed=0; remain.textContent=getCap()+'s'; bar.style.width='0%'; meter.style.display='flex';

    mediaRecorder.start(1000);
    timer=setInterval(()=>{
      elapsed++; const cap=getCap();
      bar.style.width=(elapsed/cap*100)+'%';
      remain.textContent=Math.max(0,cap-elapsed)+'s';
      if(elapsed>=cap){ stopRec(); }
    },1000);

    recActive=true;
  }

  function stopRec(){
    try{ mediaRecorder && mediaRecorder.state !== 'inactive' && mediaRecorder.stop(); }catch{}
    if(timer){ clearInterval(timer); timer=null; }
    mic.textContent='Record'; mic.classList.remove('pulse');
    recActive=false;
  }

  async function finalizeTranscription(){
    asr.textContent='Transcribing…';
    try{
      const blob = new Blob(recChunks, { type: 'audio/webm' });
      const fd = new FormData();
      // Name helps API; language hint improves accuracy
      fd.append('audio', blob, 'memoir.webm');
      fd.append('lang', BCP[lang.value] || 'fr'); // default to fr for your target

      const r = await fetch('/api/transcribe', { method: 'POST', body: fd });
      if(!r.ok){ const t=await r.text(); throw new Error(t||'fail'); }
      const data = await r.json();
      const prev = transcriptEl.textContent === 'Your words will appear here…' ? '' : transcriptEl.textContent + ' ';
      const txt = (data.text||'').trim();
      transcriptEl.textContent = (prev + txt).trim() || 'Your words will appear here…';
      save.disabled = !!txt;
      asr.textContent='Done.';
    }catch(e){
      console.error(e);
      asr.textContent='Transcription failed.';
    }finally{
      setTimeout(()=>{ asr.textContent=''; }, 2000);
    }
  }

  mic.onclick=()=>{ recActive?stopRec():startRec(); };

  /* ===== Mobile drawer and tabs ===== */
  const toggleLib=document.getElementById('toggleLib'), drawer=document.getElementById('drawer'), libraryDrawer=document.getElementById('libraryDrawer'), closeDrawer=document.getElementById('closeDrawer');
  toggleLib.onclick=()=>{ if(innerWidth>=1024){ renderLib(); } else { drawer.classList.add('show'); renderLib(true); } };
  closeDrawer.onclick=()=>drawer.classList.remove('show');
  drawer.addEventListener('click',(e)=>{ if(e.target===drawer) drawer.classList.remove('show'); });

  const tabGuided=$('tabGuided'), tabFree=$('tabFree'), guidedBlock=$('guidedBlock');
  tabGuided.onclick=()=>{ tabGuided.classList.add('active'); tabFree.classList.remove('active'); guidedBlock.style.display='block'; };
  tabFree.onclick=()=>{ tabFree.classList.add('active'); tabGuided.classList.remove('active'); guidedBlock.style.display='none'; };

  // initial
  renderPrompts(); renderLib();

  /* ===== Multilingual FAQ (unchanged) ===== */
  const FAQ = {
    en: { title: "Help / FAQ", items: [
      ["How do I use this app?","1) Pick a language. 2) Tap a topic (or choose Free). 3) Press Record and speak. 4) Stop recording, then Save story. You’ll find saved stories in Library."],
      ["How does AI rewrite work?","Open Library → Rewrite (AI). Premium/Admin only. It keeps your original; you can Undo."],
      ["How do I export stories?","Use Download .docx (zip with text) or Export CSV for a spreadsheet. PDF export is coming."],
      ["How do I sign up / log in?","Use the login page with email + password. After sign‑in you’ll land here automatically."],
      ["How do I get Premium?","Enter a trial code in the header (Redeem). Trials last 14 days. Paid plan will also unlock Premium."],
      ["Microphone or speech not working?","Allow mic permissions. Safari/iOS needs the page in the foreground with the ringer on. If speech recognition isn’t available, you can still type your story."]
    ]},
    fr: { title: "Aide / FAQ", items: [
      ["Comment utiliser l’application ?","1) Choisissez une langue. 2) Touchez un sujet (ou Free). 3) Appuyez sur Enregistrer et parlez. 4) Arrêtez, puis Enregistrer l’histoire. Vos histoires sont dans la Bibliothèque."],
      ["Comment fonctionne la réécriture IA ?","Ouvrez Bibliothèque → Réécriture (IA). Réservé Premium/Admin. L’original est conservé ; vous pouvez Annuler."],
      ["Comment exporter les histoires ?","Utilisez Télécharger .docx (zip + texte) ou Exporter CSV. L’export PDF arrive bientôt."],
      ["Comment s’inscrire / se connecter ?","Depuis la page de connexion avec e‑mail + mot de passe. Après connexion, vous arriverez ici."],
      ["Comment obtenir Premium ?","Entrez un code d’essai (Redeem) dans l’en‑tête. L’essai dure 14 jours. Un abonnement payant débloquera aussi Premium."],
      ["Micro ou voix ne fonctionnent pas ?","Autorisez l’accès au micro. Sur Safari/iOS, gardez la page au premier plan et activez le son. Si la reconnaissance vocale n’est pas dispo, vous pouvez taper votre histoire."]
    ]},
    es: { title: "Ayuda / Preguntas frecuentes", items: [
      ["¿Cómo uso la app?","1) Elige idioma. 2) Toca un tema (o Free). 3) Pulsa Grabar y habla. 4) Detén y Guarda la historia. La verás en la Biblioteca."],
      ["¿Cómo funciona la reescritura con IA?","Abre Biblioteca → Reescribir (IA). Solo Premium/Admin. Conserva el original; puedes Deshacer."],
      ["¿Cómo exporto historias?","Descarga .docx (zip con texto) o Exportar CSV. El PDF llegará pronto."],
      ["¿Cómo registrarme / iniciar sesión?","Desde la página de acceso con correo + contraseña. Tras iniciar sesión llegarás aquí."],
      ["¿Cómo obtengo Premium?","Introduce un código de prueba en la cabecera (Redeem). Dura 14 días. El plan de pago también lo desbloquea."],
      ["¿No funciona el micrófono o la voz?","Permite permisos de micrófono. En Safari/iOS, mantén la página en primer plano y el sonido activo. Si no hay reconocimiento de voz, puedes teclear tu historia."]
    ]},
    nl: { title: "Help / Veelgestelde vragen", items: [
      ["Hoe gebruik ik de app?","1) Kies een taal. 2) Tik op een onderwerp (of Free). 3) Druk op Opnemen en spreek. 4) Stop en Sla verhaal op. Je vindt verhalen in de Bibliotheek."],
      ["Hoe werkt AI‑herschrijven?","Open Bibliotheek → Herschrijf (AI). Alleen Premium/Admin. Het origineel blijft bewaard; je kunt Ongedaan maken."],
      ["Hoe exporteer ik verhalen?","Gebruik Download .docx (zip met tekst) of Exporteer CSV. PDF‑export volgt nog."],
      ["Hoe registreer / log ik in?","Via de loginpagina met e‑mail + wachtwoord. Na inloggen kom je automatisch hier."],
      ["Hoe krijg ik Premium?","Voer een proefcode in bovenaan (Redeem). Proef duurt 14 dagen. Een betaald plan geeft ook Premium."],
      ["Werkt microfoon of spraak niet?","Sta microfoontoegang toe. Op Safari/iOS moet de pagina vooraan staan en het geluid aan. Als spraakherkenning ontbreekt, kun je je verhaal typen."]
    ]}
  };
  const helpBtn   = document.getElementById('helpBtn');
  const faqDialog = document.getElementById('faqDialog');
  const faqTitle  = document.getElementById('faqTitle');
  const faqBody   = document.getElementById('faqBody');
  function renderFAQ() {
    const l = FAQ[document.getElementById('lang').value] || FAQ.en;
    faqTitle.textContent = l.title;
    faqBody.innerHTML = l.items.map(([q,a]) =>
      `<details style="margin:8px 0"><summary><strong>${q}</strong></summary><div style="margin-top:6px">${a}</div></details>`
    ).join('');
  }
  helpBtn?.addEventListener('click', () => { renderFAQ(); faqDialog.showModal(); });

})();
</script>
</body>
</html>
