<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Memoir — Recorder</title>
<meta name="color-scheme" content="light dark" />
<style>
:root{
  --bg:#f6f7fb; --card:#fff; --fg:#0f172a; --muted:#667085;
  --brand:#2563eb; --brand2:#7c3aed; --border:#e6e9f0;
  --shadow:0 20px 40px rgba(2,8,23,.06), 0 2px 6px rgba(2,8,23,.04);
}
@media (prefers-color-scheme:dark){
  :root{ --bg:#0b1020; --card:#0f162e; --fg:#e6edf7; --muted:#9aa4b2; --border:#1f2a44; --shadow:0 20px 40px rgba(0,0,0,.4), 0 2px 6px rgba(0,0,0,.3) }
}
*,*:before,*:after{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:
    radial-gradient(1200px 600px at -10% -20%, rgba(124,58,237,.12), transparent 40%),
    radial-gradient(1200px 600px at 110% -10%, rgba(37,99,235,.12), transparent 40%),
    var(--bg);
  color:var(--fg);
}
.container{max-width:980px;margin:0 auto;padding:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:20px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:36px;height:36px;border-radius:12px;background:conic-gradient(from 180deg at 50% 50%, var(--brand), var(--brand2)); box-shadow:0 6px 18px rgba(37,99,235,.35)}
h1{margin:0;font-size:clamp(1.3rem,1.2rem+1.2vw,1.8rem)}

.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
select,.btn{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:inherit}
.btn{cursor:pointer}

.shell{display:grid;gap:20px;grid-template-columns:1fr}
.left,.right{min-width:0}
.right{display:none}
@media (min-width:1024px){
  .shell{grid-template-columns:minmax(0,1fr) 380px}
  .right{display:block}
}

.label{font-size:12px;font-weight:700;text-transform:uppercase;color:var(--muted);letter-spacing:.08em;margin:10px 0 6px}

.segment{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:transparent}
.tab.active{background:rgba(37,99,235,.1);border-color:rgba(37,99,235,.25)}

.topics{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px}
.chip{
  display:flex;align-items:center;justify-content:center;
  height:44px;border-radius:12px;cursor:pointer;
  background:rgba(37,99,235,.08);border:1px solid rgba(37,99,235,.18);
  font-weight:600; letter-spacing:.2px; user-select:none;
}
.chip:active{transform:translateY(1px)}

input[type="text"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:rgba(2,8,23,.02)}
.area{min-height:180px;border:1px solid var(--border);border-radius:12px;padding:14px;background:rgba(2,8,23,.02)}

.mic-wrap{display:flex;flex-direction:column;align-items:center;gap:12px;margin:12px 0}
.mic{
  width:190px;height:190px;border-radius:999px;border:0;color:#fff;font-weight:700;font-size:20px;cursor:pointer;
  background:linear-gradient(160deg, var(--brand), var(--brand2));
  box-shadow:0 20px 44px rgba(37,99,235,.35), 0 4px 10px rgba(2,8,23,.12); position:relative;
}
.mic.pulse::after{content:"";position:absolute;inset:-8px;border-radius:999px;background:radial-gradient(closest-side, rgba(124,58,237,.25), transparent 70%);animation:pulse 1.6s infinite ease-in-out}
@keyframes pulse{0%{transform:scale(1);opacity:.9}70%{transform:scale(1.08);opacity:0}100%{transform:scale(1.12);opacity:0}}

.meter{display:flex;gap:8px;align-items:center;width:100%;max-width:420px}
.bar{flex:1;height:10px;background:rgba(2,8,23,.08);border-radius:999px;overflow:hidden}
.bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--brand),var(--brand2))}
.muted{color:var(--muted);font-size:12px}

.actions{display:flex;gap:10px;flex-wrap:wrap}
.btn.primary{background:linear-gradient(90deg,var(--brand),var(--brand2)); color:#fff; border:0}

.list{display:grid;gap:10px}
.story{padding:12px;border:1px solid var(--border);border-radius:12px;background:rgba(2,8,23,.02);display:flex;align-items:center;justify-content:space-between;gap:10px}
.story .meta{min-width:0}
.story h3{margin:0;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
.story .time{font-size:12px;color:var(--muted)}
.story .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

.drawer{position:fixed;inset:0;display:none;background:rgba(2,8,23,.45);backdrop-filter: blur(2px)}
.drawer.show{display:block}
.drawer .panel{position:absolute;right:0;top:0;bottom:0;width:88%;max-width:420px;background:var(--card);border-left:1px solid var(--border);padding:16px;overflow:auto}

dialog::backdrop{background:rgba(0,0,0,.35)}
dialog{border:none;border-radius:12px;box-shadow:var(--shadow);max-width:min(800px,92vw)}

footer{margin:22px 0;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <h1>Memoir — Recorder</h1>
        </div>
        <div class="controls">
          <select id="lang" aria-label="Language">
            <option value="en">English</option>
            <option value="fr">Français</option>
            <option value="es">Español</option>
            <option value="nl">Nederlands</option>
          </select>
          <select id="plan" aria-label="Plan">
            <option value="free">Free (2 min)</option>
            <option value="pro">Pro (longer)</option>
          </select>
          <button id="toggleLib" class="btn">☰ Library</button>
        </div>
      </header>

      <div class="shell">
        <section class="left">
          <div class="label">Mode</div>
          <div class="segment">
            <button id="tabGuided" class="tab active">Guided</button>
            <button id="tabFree" class="tab">Free</button>
          </div>

          <div id="guidedBlock">
            <div class="label">Suggested topics</div>
            <div id="prompts" class="topics"></div>
          </div>

          <div class="label">Title</div>
          <input id="title" type="text" placeholder="Story title (optional)" />

          <div class="label">Transcript</div>
          <div id="transcript" class="area" aria-live="polite">Your words will appear here…</div>

          <div class="mic-wrap">
            <button id="mic" class="mic" aria-pressed="false">Record</button>
            <div class="meter" id="meter" style="display:none">
              <div class="bar"><div id="bar"></div></div>
              <div id="remain" class="muted">120s</div>
            </div>
            <div id="asr" class="muted">Transcribing…</div>
          </div>

          <div class="actions">
            <button id="save" class="btn primary" disabled>Save story</button>
            <button id="clear" class="btn">Clear</button>
          </div>
        </section>

        <aside class="right">
          <div class="label">Library</div>
          <div id="library" class="list"></div>
        </aside>
      </div>

      <footer>Prototype: memoir recorder — EN/FR/ES/NL, 2-minute cap on Free.</footer>
    </div>
  </div>

  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="label" style="margin:0">Library</div>
        <button id="closeDrawer" class="btn">Close</button>
      </div>
      <div id="libraryDrawer" class="list"></div>
    </div>
  </div>

  <!-- JSZip for .docx generation -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
(function(){
  // ------- DOM helpers -------
  const $ = (id)=>document.getElementById(id);
  const esc = s => String(s).replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));

  // ------- Elements -------
  const lang=$('lang'), plan=$('plan');
  const promptsEl=$('prompts'), titleEl=$('title'), transcriptEl=$('transcript');
  const mic=$('mic'), meter=$('meter'), bar=$('bar'), remain=$('remain'), asr=$('asr');
  const save=$('save'), clearBtn=$('clear'), library=$('library');
  const drawer=$('drawer'), libraryDrawer=$('libraryDrawer');
  const toggleLib=$('toggleLib'), closeDrawer=$('closeDrawer');
  const tabGuided=$('tabGuided'), tabFree=$('tabFree'), guidedBlock=$('guidedBlock');

  // ------- State -------
  let locale = 'en';
  try { locale = (navigator.language||'en').slice(0,2); } catch {}
  if (!['en','fr','es','nl'].includes(locale)) locale = 'en';
  lang.value = locale;

  let tier = 'free'; plan.value = tier;
  let cap = tier==='free'?120:3600;
  let mode = 'guided';
  let transcript = '', selectedPrompt='', elapsed=0, timer=null;
  let recognition=null, rec=null, stream=null, chunks=[], audioBlob=null;

  // ------- Topics & language helpers -------
  const TOPICS = {
    en: ["Childhood","Family","School","Work","Love","War","Travel","Traditions","Holidays","Lessons","Advice","Turning-points"],
    fr: ["Enfance","Famille","École","Travail","Amour","Guerre","Voyages","Traditions","Fêtes","Leçons","Conseils","Déclics"],
    es: ["Infancia","Familia","Escuela","Trabajo","Amor","Guerra","Viajes","Tradiciones","Fiestas","Lecciones","Consejos","Puntos-clave"],
    nl: ["Jeugd","Familie","School","Werk","Liefde","Oorlog","Reizen","Tradities","Feestdagen","Lessen","Advies","Keerpunt"]
  };
  const BCP = { en:'en-US', fr:'fr-FR', es:'es-ES', nl:'nl-NL' };

  // ---- TTS helpers ----
  let voices = [];
  function loadVoices(){ voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : []; }
  if ('speechSynthesis' in window) {
    loadVoices();
    window.speechSynthesis.onvoiceschanged = loadVoices;
  }
  function speak(text, langCode){
    if (!('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    const target = BCP[langCode] || 'en-US';
    u.lang = target;
    const v = voices.find(v=>v.lang === target) || voices.find(v=>v.lang.startsWith(target.split('-')[0])) || null;
    if (v) u.voice = v;
    u.rate = 0.92; u.pitch = 0.95; u.volume = 0.9; // gentle
    window.speechSynthesis.speak(u);
  }

  // ------- Storage helpers -------
  const KEY='memoir_stories';
  const getAll = ()=>{ try{return JSON.parse(localStorage.getItem(KEY)||'[]')}catch{return[]} };
  const setAll = (arr)=>localStorage.setItem(KEY, JSON.stringify(arr));

  // ------- UI renderers -------
  function renderPrompts(){
    promptsEl.innerHTML='';
    const list = TOPICS[lang.value] || TOPICS.en;
    list.forEach(topic=>{
      const b=document.createElement('div');
      b.className='chip'; b.textContent=topic;
      b.onclick=()=>{
        selectedPrompt = topic;
        speak(topic, lang.value);
        if (!titleEl.value) titleEl.value = topic;
      };
      promptsEl.appendChild(b);
    });
  }

  function storyRow(s){
    const row=document.createElement('div'); row.className='story';

    const meta=document.createElement('div'); meta.className='meta';
    const h=document.createElement('h3'); h.textContent=s.title || 'Story';
    const t=document.createElement('div'); t.className='time'; t.textContent=new Date(s.createdAt).toLocaleString();
    meta.appendChild(h); meta.appendChild(t);

    const actions=document.createElement('div'); actions.className='row';
    const view=document.createElement('button'); view.className='btn'; view.textContent='View';
    view.onclick=()=>viewStory(s);
    const rewrite=document.createElement('button'); rewrite.className='btn'; rewrite.textContent='Rewrite (AI)';
    rewrite.onclick=()=>rewriteAI(s);
    const undo=document.createElement('button'); undo.className='btn'; undo.textContent='Undo';
    if(!s.originalTranscript){ undo.disabled = true; undo.title = 'No original saved'; }
    undo.onclick=()=>undoRewrite(s);
    const dl=document.createElement('button'); dl.className='btn'; dl.textContent='Download .docx';
    dl.onclick=()=>downloadDocx(s);
    const del=document.createElement('button'); del.className='btn'; del.textContent='Delete';
    del.onclick=()=>{ const next=getAll().filter(x=>x.id!==s.id); setAll(next); renderLib(); };

    actions.appendChild(view); actions.appendChild(rewrite); actions.appendChild(undo); actions.appendChild(dl); actions.appendChild(del);
    row.appendChild(meta); row.appendChild(actions);
    return row;
  }

  function renderLib(){
    const target=(window.innerWidth>=1024)?library:libraryDrawer;
    target.innerHTML='';
    const items=getAll();
    if(!items.length){ const p=document.createElement('p'); p.className='muted'; p.textContent='No stories yet.'; target.appendChild(p); return; }
    for(const s of items){ target.appendChild(storyRow(s)); }
  }

  function viewStory(s){
    const dlg=document.createElement('dialog');
    dlg.style.width='min(90vw, 820px)'; dlg.innerHTML =
      `<form method="dialog" style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #e5e7eb">
         <div style="font-weight:700">${esc(s.title||'Story')}</div>
         <button autofocus class="btn">Close</button>
       </form>
       <div style="padding:16px">
         <div class="muted" style="margin-bottom:6px">${new Date(s.createdAt).toLocaleString()}</div>
         <div style="white-space:pre-wrap;font-family:system-ui">${esc(s.transcript||'')}</div>
         ${s.audioURL ? `<div style="margin-top:12px"><audio controls src="${s.audioURL}"></audio></div>` : ''}
       </div>`;
    document.body.appendChild(dlg);
    dlg.addEventListener('close', ()=> dlg.remove());
    dlg.showModal();
  }

  // ------- Drawer & resize -------
  toggleLib.onclick=()=>{ if(window.innerWidth>=1024){ window.scrollTo({top:0,behavior:'smooth'}) } else { drawer.classList.add('show'); renderLib(); } };
  closeDrawer.onclick=()=>drawer.classList.remove('show');
  drawer.addEventListener('click',(e)=>{ if(e.target===drawer) drawer.classList.remove('show') });
  window.addEventListener('resize',renderLib);

  // ------- Tabs -------
  tabGuided.onclick=()=>{ mode='guided'; tabGuided.classList.add('active'); tabFree.classList.remove('active'); guidedBlock.style.display='block'; };
  tabFree.onclick=()=>{ mode='free'; tabFree.classList.add('active'); tabGuided.classList.remove('active'); guidedBlock.style.display='none'; };

  // ------- Controls -------
  plan.onchange=()=>{ tier=plan.value; cap=tier==='free'?120:3600; remain.textContent = cap+'s'; };
  lang.onchange=()=>{ renderPrompts(); };  // refresh guided topics on language change
  clearBtn.onclick=()=>{ transcript=''; transcriptEl.textContent='Your words will appear here…'; titleEl.value=''; save.disabled=true; };

  // ------- Recording -------
  mic.onclick = async ()=>{ if(rec && rec.state!=='inactive'){ stopAll(); } else { await startAll(); } };

  async function startAll(){
    transcript=''; transcriptEl.textContent=''; elapsed=0; remain.textContent = cap+'s'; bar.style.width='0%';

    try{
      stream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true}});
    }catch(e){ alert('Microphone permission denied. Check site settings.'); return; }

    // MediaRecorder
    chunks=[]; audioBlob=null; rec=null;
    try{
      if(window.MediaRecorder){
        const prefs=['audio/webm;codecs=opus','audio/webm','audio/mp4;codecs=mp4a.40.2','audio/mp4','audio/ogg;codecs=opus'];
        let mime=''; for(const t of prefs){ if(MediaRecorder.isTypeSupported?.(t)){ mime=t; break; } }
        rec=new MediaRecorder(stream, mime?{mimeType:mime}:{});
        rec.ondataavailable=(e)=>{ if(e.data?.size) chunks.push(e.data); };
        rec.onstop=()=>{ try{stream.getTracks().forEach(t=>t.stop());}catch{} const type=mime||(chunks[0]?.type||'audio/mp4'); audioBlob=chunks.length?new Blob(chunks,{type}):null; };
        rec.start();
      }
    }catch{ rec=null; }

    // Speech recognition in selected language
    const SR = window.webkitSpeechRecognition || window.SpeechRecognition;
    if(SR){
      recognition=new SR();
      recognition.lang = BCP[lang.value] || 'en-US';
      recognition.continuous=true; recognition.interimResults=true;
      let full='';
      recognition.onresult=(e)=>{
        let inter='';
        for(let i=e.resultIndex;i<e.results.length;i++){
          const r=e.results[i];
          if(r.isFinal) full+=r[0].transcript+' ';
          else inter+=r[0].transcript;
        }
        transcript=(full+inter).trim();
        transcriptEl.textContent=transcript;
        save.disabled=!transcript;
      };
      recognition.onerror=()=>{ asr.textContent='Speech recognition unavailable'; };
      try{ recognition.start(); asr.textContent='Transcribing…'; }catch{}
    } else {
      asr.textContent='Speech recognition is not available in this browser.';
    }

    mic.textContent='Stop Recording'; mic.classList.add('pulse'); meter.style.display='flex';
    timer=setInterval(()=>{ elapsed++; bar.style.width=(elapsed/cap*100)+'%'; remain.textContent=Math.max(0,cap-elapsed)+'s'; if(elapsed>=cap) stopAll(); },1000);
  }

  function stopAll(){
    if(rec && rec.state!=='inactive'){ rec.stop(); }
    if(recognition){ try{ recognition.stop(); }catch{} }
    if(timer){ clearInterval(timer); timer=null; }
    mic.textContent='Record'; mic.classList.remove('pulse');
  }

  // ------- Save -------
  save.onclick=()=>{
    const audioURL = audioBlob ? URL.createObjectURL(audioBlob) : undefined;
    const item = { id:Math.random().toString(36).slice(2), createdAt:Date.now(), title:titleEl.value||'Story', mode, prompt:mode==='guided'?selectedPrompt:undefined, transcript, audioURL, durationSec:elapsed };
    const prev=getAll(); prev.unshift(item); setAll(prev);
    renderLib(); clearBtn.onclick();
  };

  // ------- Rewrite (AI) — updates saved story in place -------
  async function rewriteAI(s){
    const tone="warm, vivid, cohesive";
    const language = lang.value; // send chosen language downstream
    try{
      const res = await fetch('/api/rewrite',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:s.transcript,title:s.title,language,tone})});
      if(!res.ok){ let msg=await res.text(); try{msg=JSON.parse(msg).error||msg;}catch{} throw new Error(msg||'Rewrite failed'); }
      const data=await res.json(); const rewritten=data.text||'(no text)';

      const items=getAll();
      const idx=items.findIndex(x=>x.id===s.id);
      if(idx>=0){
        if(!items[idx].originalTranscript) items[idx].originalTranscript = items[idx].transcript;
        items[idx].transcript = rewritten;
        items[idx].rewrittenAt = Date.now();
        setAll(items);
        renderLib();

        // Confirmation modal
        const dlg=document.createElement('dialog');
        dlg.innerHTML = `<form method="dialog" style="padding:12px;border-bottom:1px solid #e5e7eb">
            <strong>${esc(items[idx].title)}</strong>&nbsp;—&nbsp;<span class="muted">Updated</span>
            <button autofocus class="btn" style="float:right">Close</button>
          </form>
          <div style="padding:16px;white-space:pre-wrap;font-family:system-ui">${esc(rewritten)}</div>`;
        document.body.appendChild(dlg); dlg.addEventListener('close',()=>dlg.remove()); dlg.showModal();
      }
    }catch(err){
      alert('Rewrite error: ' + (err?.message||err));
    }
  }

  // ------- Undo to original -------
  function undoRewrite(s){
    const items=getAll();
    const idx=items.findIndex(x=>x.id===s.id);
    if(idx<0) return;
    if(!items[idx].originalTranscript){ alert('No original version available.'); return; }
    items[idx].transcript = items[idx].originalTranscript;
    delete items[idx].originalTranscript;
    items[idx].rewrittenAt = null;
    setAll(items);
    renderLib();
  }

  // ------- Download .docx (client-side, minimal OOXML) -------
  async function downloadDocx(s){
    const JSZip = window.JSZip;
    const zip = new JSZip();

    const paras = String(s.transcript||'').trim().split(/\n\s*\n/).map(p=>`<w:p><w:r><w:t>${escapeXml(p)}</w:t></w:r></w:p>`).join('');
    const title = escapeXml(s.title||'Story');

    zip.file('[Content_Types].xml', `
      <?xml version="1.0" encoding="UTF-8"?>
      <Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
        <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
        <Default Extension="xml" ContentType="application/xml"/>
        <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
        <Override PartName="/docProps/core.xml" ContentType="application/vnd.openxmlformats-package.core-properties+xml"/>
        <Override PartName="/docProps/app.xml" ContentType="application/vnd.openxmlformats-officedocument.extended-properties+xml"/>
      </Types>`.trim());

    zip.folder('_rels').file('.rels', `
      <?xml version="1.0" encoding="UTF-8"?>
      <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
        <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
        <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties" Target="docProps/core.xml"/>
        <Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/extended-properties" Target="docProps/app.xml"/>
      </Relationships>`.trim());

    zip.folder('docProps').file('core.xml', `
      <?xml version="1.0" encoding="UTF-8"?>
      <cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties"
        xmlns:dc="http://purl.org/dc/elements/1.1/"
        xmlns:dcterms="http://purl.org/dc/terms/"
        xmlns:dcmitype="http://purl.org/dc/dcmitype/"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
        <dc:title>${title}</dc:title>
        <dc:creator>Memoir Recorder</dc:creator>
        <cp:lastModifiedBy>Memoir Recorder</cp:lastModifiedBy>
        <dcterms:created xsi:type="dcterms:W3CDTF">${new Date().toISOString()}</dcterms:created>
        <dcterms:modified xsi:type="dcterms:W3CDTF">${new Date().toISOString()}</dcterms:modified>
      </cp:coreProperties>`.trim());

    zip.folder('docProps').file('app.xml', `
      <?xml version="1.0" encoding="UTF-8"?>
      <Properties xmlns="http://schemas.openxmlformats.org/officeDocument/2006/extended-properties"
        xmlns:vt="http://schemas.openxmlformats.org/officeDocument/2006/docPropsVTypes">
        <Application>Memoir Recorder</Application>
        <DocSecurity>0</DocSecurity>
        <ScaleCrop>false</ScaleCrop>
        <HeadingPairs>
          <vt:vector size="2" baseType="variant">
            <vt:variant><vt:lpstr>Title</vt:lpstr></vt:variant>
            <vt:variant><vt:i4>1</vt:i4></vt:variant>
          </vt:vector>
        </HeadingPairs>
        <TitlesOfParts>
          <vt:vector size="1" baseType="lpstr">
            <vt:lpstr>${title}</vt:lpstr>
          </vt:vector>
        </TitlesOfParts>
      </Properties>`.trim());

    const word = zip.folder('word');
    word.folder('_rels').file('document.xml.rels', `
      <?xml version="1.0" encoding="UTF-8"?>
      <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"></Relationships>`.trim());

    word.file('document.xml', `
      <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
      <w:document xmlns:wpc="http://schemas.microsoft.com/office/word/2010/wordprocessingCanvas"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:o="urn:schemas-microsoft-com:office:office"
        xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"
        xmlns:m="http://schemas.openxmlformats.org/officeDocument/2006/math"
        xmlns:v="urn:schemas-microsoft-com:vml"
        xmlns:wp14="http://schemas.microsoft.com/office/word/2010/wordprocessingDrawing"
        xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing"
        xmlns:w10="urn:schemas-microsoft-com:office:word"
        xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
        xmlns:w14="http://schemas.microsoft.com/office/word/2010/wordml"
        xmlns:wpg="http://schemas.microsoft.com/office/word/2010/wordprocessingGroup"
        xmlns:wpi="http://schemas.microsoft.com/office/word/2010/wordprocessingInk"
        xmlns:wne="http://schemas.microsoft.com/office/word/2006/wordml"
        xmlns:wps="http://schemas.microsoft.com/office/word/2010/wordprocessingShape"
        mc:Ignorable="w14 wp14">
        <w:body>
          <w:p><w:r><w:t xml:space="preserve">${title}</w:t></w:r></w:p>
          ${paras}
          <w:sectPr><w:pgSz w:w="12240" w:h="15840"/><w:pgMar w:top="1440" w:right="1440" w:bottom="1440" w:left="1440"/></w:sectPr>
        </w:body>
      </w:document>`.trim());

    const blob = await zip.generateAsync({ type:'blob' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (s.title || 'Story') + '.docx';
    document.body.appendChild(a); a.click(); a.remove();
  }
  function escapeXml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // ------- Init -------
  renderPrompts(); renderLib();

  // expose for safety if needed
  window.viewStory = viewStory;
  window.rewriteAI = rewriteAI;
  window.undoRewrite = undoRewrite;
  window.downloadDocx = downloadDocx;

  // ------- Recording helpers at end to avoid hoisting surprises -------
  function stopAll(){
    if(rec && rec.state!=='inactive'){ rec.stop(); }
    if(recognition){ try{ recognition.stop(); }catch{} }
    if(timer){ clearInterval(timer); timer=null; }
    mic.textContent='Record'; mic.classList.remove('pulse');
  }

})();
</script>
</body>
</html>
