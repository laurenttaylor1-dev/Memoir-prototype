<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Memoir Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: sans-serif; margin: 20px; background:#fafafa; }
    h1 { text-align: center; }
    .toolbar, .guided { margin: 10px 0; text-align: center; }
    button { margin: 5px; padding: 10px 15px; border-radius: 8px; border:none; cursor:pointer; background:#007bff; color:white; }
    button:hover { background:#0056b3; }
    #library { margin-top:20px; }
    .story-item { padding:10px; border-bottom:1px solid #ddd; }
  </style>
</head>
<body>
  <h1>Memoir Prototype</h1>

  <div class="toolbar">
    <button id="recordBtn">ðŸŽ¤ Record</button>
    <button id="rewriteBtn">âœ¨ Rewrite</button>
    <button id="undoBtn">â†© Undo</button>
    <button id="downloadBtn">â¬‡ Download .docx</button>
    <select id="languageSelect">
      <option value="en">English</option>
      <option value="fr">FranÃ§ais</option>
      <option value="nl">Nederlands</option>
      <option value="es">EspaÃ±ol</option>
    </select>
  </div>

  <div class="guided">
    <h3>Guided Topics</h3>
    <div id="topics"></div>
  </div>

  <div id="library">
    <h3>Library</h3>
    <div id="stories"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- Supabase setup ---
    const SUPABASE_URL = "https://jrjqciywlijhhcxfxywh.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpyanFjaXl3bGlqaGhjeGZ4eXdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MDQ2NzEsImV4cCI6MjA3MTA4MDY3MX0.5FeQxu_N7q-1Br00yJu4E-TKTZK4U4ZnJ4jpRo7Atak";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- Guided topics + prompts ---
    const TOPICS = {
      en: { Childhood: "Tell me something about your childhood.", Youth: "Tell me something about your youth.", Family: "Tell me something about your family.", Work: "Tell me something about your work.", TurningPoints: "Tell me about turning points in your life." },
      fr: { Enfance: "Racontez-moi quelque chose sur votre enfance.", Jeunesse: "Racontez-moi quelque chose sur votre jeunesse.", Famille: "Racontez-moi quelque chose sur votre famille.", Travail: "Racontez-moi quelque chose sur votre travail.", Tournants: "Parlez-moi des tournants de votre vie." },
      nl: { Jeugd: "Vertel me iets over je jeugd.", Familie: "Vertel me iets over je familie.", Werk: "Vertel me iets over je werk.", Keerpunt: "Vertel me over keerpunten in je leven." },
      es: { Infancia: "CuÃ©ntame algo sobre tu infancia.", Juventud: "CuÃ©ntame algo sobre tu juventud.", Familia: "CuÃ©ntame algo sobre tu familia.", Trabajo: "CuÃ©ntame algo sobre tu trabajo.", PuntosClave: "HÃ¡blame de momentos clave en tu vida." }
    };

    // --- ElevenLabs voices ---
    const VOICE_BY_LANG = {
      en: "KoVIHoyLDrQyd4pGalbs", // English
      fr: "TfGtrgcVrXWjJkeB51T1", // French
      nl: "yO6w2xlECAQRFP6pX7Hw", // Dutch
      es: "ZpEtuMdTIlJXYXAhevhG"  // Spanish
    };

    // --- State ---
    let currentLanguage = "en";
    let stories = [];
    let lastText = "";

    const languageSelect = document.getElementById("languageSelect");
    const topicsDiv = document.getElementById("topics");
    const storiesDiv = document.getElementById("stories");

    // --- Render guided topics ---
    function renderTopics() {
      topicsDiv.innerHTML = "";
      const langTopics = TOPICS[currentLanguage];
      Object.entries(langTopics).forEach(([key, phrase]) => {
        const btn = document.createElement("button");
        btn.textContent = key;
        btn.onclick = () => speakTopic(currentLanguage, phrase);
        topicsDiv.appendChild(btn);
      });
    }

    // --- Speak with ElevenLabs ---
    async function speakTopic(lang, phrase) {
      try {
        const res = await fetch("/api/voice", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: phrase, voiceId: VOICE_BY_LANG[lang] })
        });
        if (!res.ok) throw new Error("TTS failed");
        const arrayBuffer = await res.arrayBuffer();
        const blob = new Blob([arrayBuffer], { type: "audio/mpeg" });
        const url = URL.createObjectURL(blob);
        const audio = new Audio(url);
        audio.play();
      } catch (err) {
        console.error("TTS error:", err);
        // Fallback to system voice
        const utterance = new SpeechSynthesisUtterance(phrase);
        utterance.lang = lang;
        speechSynthesis.speak(utterance);
      }
    }

    // --- Story library ---
    function renderStories() {
      storiesDiv.innerHTML = "";
      stories.forEach((s, idx) => {
        const div = document.createElement("div");
        div.className = "story-item";
        div.textContent = `${s.title} (${s.date})`;
        storiesDiv.appendChild(div);
      });
    }

    // --- Dummy record, rewrite, undo, download ---
    document.getElementById("recordBtn").onclick = () => {
      const title = "Story " + (stories.length+1);
      const text = "This is a dummy recorded story.";
      lastText = text;
      stories.push({ title, date: new Date().toLocaleString(), text });
      renderStories();
    };

    document.getElementById("rewriteBtn").onclick = () => {
      if (!lastText) return alert("No story to rewrite.");
      lastText = "[Rewritten] " + lastText;
      stories[stories.length-1].text = lastText;
      alert("Story rewritten.");
    };

    document.getElementById("undoBtn").onclick = () => {
      if (stories.length > 0) {
        stories.pop();
        renderStories();
      }
    };

    document.getElementById("downloadBtn").onclick = () => {
      if (stories.length === 0) return;
      const content = stories.map(s => s.title + "\n" + s.text).join("\n\n");
      const blob = new Blob([content], { type: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "memoirs.docx";
      a.click();
    };

    languageSelect.onchange = () => {
      currentLanguage = languageSelect.value;
      renderTopics();
    };

    // Init
    renderTopics();
    renderStories();
  </script>
</body>
</html>
