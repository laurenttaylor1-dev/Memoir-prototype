<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Memoir — Settings</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div id="site-header"></div>

  <main class="container">
    <h1 class="section-title" id="stgTitle">Settings</h1>

    <div class="card" style="margin-bottom:16px">
      <h2 class="section-title" id="acctTitle">Account</h2>
      <p id="acctDesc" class="muted">Manage your login and personal settings.</p>
      <div id="acctBox" class="mini-card" style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
        <div>
          <div class="label" id="acctStatusLbl">Status</div>
          <div id="acctStatusVal">Signed out</div>
        </div>
        <div style="display:flex;gap:10px">
          <a href="/login.html" class="btn" id="btnSignIn">Sign in</a>
          <button class="btn" id="btnSignOut">Sign out</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-bottom:16px">
      <h2 class="section-title" id="subTitle">Subscription</h2>
      <div class="mini-card" style="display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center">
        <div>
          <div class="label" id="planLabel">Current plan</div>
          <div id="planName">Free</div>
          <div class="muted" id="planNext">Next billing: —</div>
        </div>
        <div style="display:flex;gap:10px">
          <a href="/checkout.html" class="btn primary" id="btnUpgrade">Upgrade</a>
          <button class="btn" id="btnManageBilling">Manage billing</button>
        </div>
      </div>
      <p id="subNote" class="muted" style="margin-top:10px">
        You’ll be charged monthly. You can cancel anytime from the billing portal.
      </p>
    </div>

    <div class="card" style="margin-bottom:16px">
      <h2 class="section-title" id="faqTitle">FAQ</h2>
      <details>
        <summary id="qFree">Is there a free plan?</summary>
        <div id="aFree" class="muted">Yes, you can try the app for free before upgrading.</div>
      </details>
      <details>
        <summary id="qLangs">Which languages are supported?</summary>
        <div id="aLangs" class="muted">English, Français, Nederlands, Español (more coming).</div>
      </details>
      <details>
        <summary id="qTrans">How is transcription done?</summary>
        <div id="aTrans" class="muted">Server-side Whisper for high accuracy; works offline then syncs later.</div>
      </details>
    </div>

    <div class="card">
      <h2 class="section-title" id="legalTitle">Legal</h2>
      <ul class="muted" style="margin:0;padding-left:18px">
        <li><a href="/legal/privacy.html" id="linkPrivacy">Privacy Policy</a></li>
        <li><a href="/legal/terms.html" id="linkTerms">Terms of Service</a></li>
      </ul>
    </div>
  </main>

  <div id="site-footer"></div>

  <script src="/js/lang.js" defer></script>
  <script src="/js/header-loader.js" defer></script>
  <script>
    // Minimal “session” detection. If you use Supabase Auth, replace this block with your client check.
    // This reads a simple cookie/localStorage flag you may already set after login.
    function getUserEmail(){
      try{
        return localStorage.getItem('memoir_user_email') || '';
      }catch{return '';}
    }

    async function openBillingPortal(){
      try{
        // If you already have an API route that returns {url}, call it here.
        // Examples you may have: /api/checkout.js?mode=portal  OR  /api/stripe-portal
        const r = await fetch('/api/checkout.js?mode=portal');
        const { url } = await r.json();
        if(url) window.location.href = url; else alert('Unable to open billing portal.');
      }catch(e){ alert('Unable to open billing portal.'); }
    }

    function applySettingsLang(code){
      const t = (window.MEMOIR_I18N?.strings?.[code]) || window.MEMOIR_I18N.strings.en;

      // Titles/labels
      stgTitle.textContent = t.stgTitle;
      acctTitle.textContent = t.acctTitle;
      acctDesc.textContent = t.acctDesc;
      acctStatusLbl.textContent = t.acctStatusLbl;
      btnSignIn.textContent = t.btnSignIn;
      btnSignOut.textContent = t.btnSignOut;

      subTitle.textContent = t.subTitle;
      planLabel.textContent = t.planLabel;
      btnUpgrade.textContent = t.upgrade;
      btnManageBilling.textContent = t.btnManageBilling;
      subNote.textContent = t.subNote;

      // FAQ & legal reuse footer strings + extra
      document.getElementById('faqTitle').textContent = t.faqTitle;
      qFree.textContent = t.qFree;   aFree.textContent = t.aFree;
      qLangs.textContent = t.qLangs; aLangs.textContent = t.aLangs;
      qTrans.textContent = t.qTrans; aTrans.textContent = t.aTrans;
      legalTitle.textContent = t.legalTitle;
      linkPrivacy.textContent = t.linkPrivacy;
      linkTerms.textContent = t.linkTerms;
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const code = window.MEMOIR_I18N?.getLang?.() || 'en';
      applySettingsLang(code);

      // Set account status from local storage or your auth
      const email = getUserEmail();
      if(email){
        acctStatusVal.textContent = email;
        btnSignIn.style.display = 'none';
        btnSignOut.style.display = '';
      }else{
        acctStatusVal.textContent = (window.MEMOIR_I18N?.strings?.[code]?.signedOut) || 'Signed out';
        btnSignIn.style.display = '';
        btnSignOut.style.display = 'none';
      }

      btnSignOut.addEventListener('click', ()=>{
        try{ localStorage.removeItem('memoir_user_email'); }catch{}
        window.location.href = '/landing.html';
      });

      btnManageBilling.addEventListener('click', openBillingPortal);

      // Optional: fetch live subscription info if you expose an API like /api/subscription
      // Expected { planName, nextBillingISO }
      fetch('/api/subscription').then(r=>r.ok?r.json():null).then(data=>{
        if(!data) return;
        planName.textContent = data.planName || planName.textContent;
        if(data.nextBillingISO){
          const dt = new Date(data.nextBillingISO);
          const code2 = window.MEMOIR_I18N?.getLang?.() || 'en';
          const t = window.MEMOIR_I18N.strings[code2];
          planNext.textContent = (t.subNext || 'Next billing:') + ' ' + dt.toLocaleDateString();
        }
      }).catch(()=>{});
    });

    window.addEventListener('memoir:lang', e=>applySettingsLang(e.detail.code));
  </script>
</body>
</html>
