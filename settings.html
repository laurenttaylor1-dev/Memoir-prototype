<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Memoir — Settings</title>
  <meta name="theme-color" content="#f4ead9"/>
  <link rel="stylesheet" href="/styles.css">
  <style>
    :root{
      --bg:#f6f1ea; --card:#fffaf5; --ink:#3b2f2a; --muted:#7b6a62;
      --accent:#8c5a3c; --accent2:#b17d55; --radius:22px;
      --shadow:0 18px 40px rgba(59,47,42,.10),0 2px 8px rgba(59,47,42,.06);
    }
    body{background:var(--bg); color:var(--ink); margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:900px; margin:0 auto; padding:24px 16px 40px}
    h1{font-size:clamp(28px,3.2vw,42px); margin:10px 0 18px; font-weight:800}
    .card{background:var(--card); border:1px solid rgba(0,0,0,.08); border-radius:var(--radius); box-shadow:var(--shadow); padding:22px}
    .row{display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .muted{color:var(--muted)}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:999px; border:1px solid rgba(0,0,0,.12); background:#fff; color:var(--ink); font-weight:700; cursor:pointer; text-decoration:none}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#fff; border:0}
    .error{color:#a23a3a; margin-top:10px}
    .notice{margin:10px 0 18px; padding:10px 14px; border-radius:12px; background:#e9f7ef; color:#1b5e20; border:1px solid #c7ebd2; display:none}
    .kv{display:grid; grid-template-columns:160px 1fr; gap:10px; margin-top:14px}
    code.small{font-size:12px; color:var(--muted)}
  </style>

  <!-- If login.html already set these, we reuse; otherwise define here -->
  <script>
    (function ensureSupabaseEnv(){
      if (!window.MEMOIR_SUPABASE_URL) {
        window.MEMOIR_SUPABASE_URL  = "https://fswxkujxusdozvmpyvzk.supabase.co";
      }
      if (!window.MEMOIR_SUPABASE_ANON) {
        window.MEMOIR_SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzd3hrdWp4dXNkb3p2bXB5dnprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMTk3MTYsImV4cCI6MjA3MzY5NTcxNn0.kNodFgDXi32w456e475fXvBi9eehX50HX_hVVTDBtXI";
      }
    })();
  </script>
</head>
<body>
  <div id="site-header"></div>

  <main class="container">
    <h1>Settings</h1>
    <div id="topNotice" class="notice"></div>

    <section class="card" id="acctCard">
      <h2 style="margin:0 0 6px">Account</h2>
      <div id="acctStatus" class="muted">Checking your session…</div>

      <div id="acctBody" style="display:none">
        <div class="kv">
          <div class="muted">Email</div>
          <div id="acctEmail">—</div>

          <div class="muted">User ID</div>
          <div><code class="small" id="acctId">—</code></div>

          <div class="muted">Created</div>
          <div id="acctCreated">—</div>
        </div>

        <div class="row" style="margin-top:16px">
          <a class="btn" href="/login.html">Back to login</a>
          <button id="btnSignOut" class="btn primary" type="button">Sign out</button>
        </div>

        <div id="acctErr" class="error"></div>
      </div>
    </section>
  </main>

  <div id="site-footer"></div>

  <script src="/js/header-loader.js" defer></script>
  <script src="/js/footer-loader.js" defer></script>
  <!-- Load Supabase once -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const statusEl = document.getElementById('acctStatus');
      const bodyEl   = document.getElementById('acctBody');
      const errEl    = document.getElementById('acctErr');
      const noticeEl = document.getElementById('topNotice');

      let SB = null;

      // 1) Init client safely
      try {
        if (!window.supabase || !window.supabase.createClient) {
          throw new Error('Supabase SDK not loaded');
        }
        SB = window.supabase.createClient(
          window.MEMOIR_SUPABASE_URL,
          window.MEMOIR_SUPABASE_ANON,
          { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } }
        );
      } catch (e) {
        console.error('[settings] Supabase init failed:', e);
        statusEl.textContent = 'Could not load authentication — try refreshing.';
        return;
      }

      // 2) Handle hash messages from confirm/recovery
      (async function handleHash(){
        const h = location.hash || '';
        if (!h) return;
        if (h.includes('type=recovery')) {
          noticeEl.textContent = 'Set a new password below (once signed in, it will reflect here).';
          noticeEl.style.display = 'block';
        } else if (h.includes('type=signup')) {
          noticeEl.textContent = 'Email confirmed.';
          noticeEl.style.display = 'block';
        }
      })();

      // 3) Resolve session with a timeout (prevents endless "Checking…")
      const withTimeout = (p, ms=8000) =>
        Promise.race([p, new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),ms))]);

      async function loadSession() {
        try {
          const { data } = await withTimeout(SB.auth.getSession());
          const session = data?.session || null;

          // If no session -> go to login with return URL
          if (!session) {
            const ret = encodeURIComponent(location.pathname);
            location.href = `/login.html?return=${ret}`;
            return;
          }

          // We have a session: render user info
          const user = session.user;
          statusEl.style.display = 'none';
          bodyEl.style.display = 'block';
          document.getElementById('acctEmail').textContent   = user.email || '—';
          document.getElementById('acctId').textContent      = user.id || '—';
          document.getElementById('acctCreated').textContent = user.created_at ? new Date(user.created_at).toLocaleString() : '—';
        } catch (e) {
          console.error('[settings] getSession error:', e);
          statusEl.textContent = e?.message === 'timeout'
            ? 'Auth is slow to respond. Please refresh.'
            : 'Could not check your session.';
        }
      }

      // 4) Also react to auth state changes (e.g., right after redirect)
      SB.auth.onAuthStateChange((_event, session) => {
        if (session) {
          statusEl.style.display = 'none';
          bodyEl.style.display = 'block';
          const user = session.user;
          document.getElementById('acctEmail').textContent   = user.email || '—';
          document.getElementById('acctId').textContent      = user.id || '—';
          document.getElementById('acctCreated').textContent = user.created_at ? new Date(user.created_at).toLocaleString() : '—';
        }
      });

      // 5) Sign out
      document.getElementById('btnSignOut')?.addEventListener('click', async () => {
        errEl.textContent = '';
        try {
          const { error } = await SB.auth.signOut();
          if (error) throw error;
          location.href = '/login.html';
        } catch (ex) {
          errEl.textContent = ex?.message || 'Could not sign out.';
        }
      });

      // Fire initial load
      loadSession();
    });
  </script>
</body>
</html>
