<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Memoir — Settings</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    :root{--bg:#f6f1ea;--card:#fffaf5;--ink:#3b2f2a;--muted:#7b6a62;--accent:#8c5a3c;--accent2:#b17d55;--radius:18px;--shadow:0 18px 40px rgba(59,47,42,.10),0 2px 8px rgba(59,47,42,.06)}
    body{background:var(--bg);color:var(--ink);margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:1100px;margin:0 auto;padding:20px 16px 28px}
    .title{font-size:clamp(26px,3vw,38px);margin:8px 0 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid rgba(0,0,0,.08);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .card h3{margin:0 0 10px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid rgba(0,0,0,.12);background:#fff;color:#3b2f2a;text-decoration:none;font-weight:600;cursor:pointer}
    .pill.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border:0}
    .muted{color:var(--muted)}
    .list{margin:0 0 0 18px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .ok{color:#1b5e20}
    .warn{color:#8a1f17}
  </style>

  <!-- Project keys -->
  <script>
    window.MEMOIR_SUPABASE_URL  = window.MEMOIR_SUPABASE_URL  || "https://fswxkujxusdozvmpyvzk.supabase.co";
    window.MEMOIR_SUPABASE_ANON = window.MEMOIR_SUPABASE_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzd3hrdWp4dXNkb3p2bXB5dnprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMTk3MTYsImV4cCI6MjA3MzY5NTcxNn0.kNodFgDXi32w456e475fXvBi9eehX50HX_hVVTDBtXI";
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="site-header"></div>

  <main class="container">
    <h1 class="title" id="pageTitle">Settings</h1>

    <section class="grid">
      <!-- Account -->
      <div class="card" id="accountCard">
        <h3>Account</h3>
        <p class="muted" id="accountBlurb">Checking your session…</p>
        <div class="row" id="accountActions" style="margin-top:8px"></div>
      </div>

      <!-- Subscription -->
      <div class="card" id="subCard">
        <h3>Subscription</h3>
        <p class="muted" id="subBlurb">Choose or change your plan.</p>
        <div class="list" id="subPlans">
          <p><strong>Storyteller — €8.99/month</strong> — <a href="/api/checkout?price=storyteller" class="pill primary">Subscribe</a></p>
          <p><strong>Premium Storyteller — €11.99/month</strong> — <a href="/api/checkout?price=premium" class="pill primary">Subscribe</a></p>
          <p><strong>Exclusive Storyteller — €15.99/month</strong> — <a href="/api/checkout?price=exclusive" class="pill primary">Subscribe</a></p>
        </div>
      </div>

      <!-- Billing -->
      <div class="card">
        <h3>Billing</h3>
        <p class="muted">View invoices and next renewal.</p>
        <a class="pill" href="/api/billing-portal">Manage billing</a>
      </div>

      <!-- FAQ -->
      <div class="card">
        <h3>FAQ</h3>
        <ul class="list">
          <li>Is there a free plan? — Yes, with a 2-minute per recording cap.</li>
          <li>Which languages are supported? — English, French, Dutch, Spanish for UI; stories can be any language.</li>
          <li>How is transcription done? — We’ll add automatic transcription on save (coming in beta).</li>
        </ul>
      </div>

      <!-- Plan details -->
      <div class="card" style="grid-column:1/-1">
        <h3>Subscription details</h3>
        <div class="grid">
          <div class="card">
            <h4>Storyteller — €8.99/month</h4>
            <ul class="list">
              <li>3 hours transcription / month</li>
              <li>Share with up to 4 family members (read-only)</li>
              <li>Private library</li>
            </ul>
          </div>
          <div class="card">
            <h4>Premium Storyteller — €11.99/month</h4>
            <ul class="list">
              <li>6 hours transcription / month</li>
              <li>Share with up to 4 family members (read-only)</li>
              <li>Priority processing</li>
            </ul>
          </div>
          <div class="card">
            <h4>Exclusive Storyteller — €15.99/month</h4>
            <ul class="list">
              <li>10 hours transcription / month</li>
              <li>Share with up to 4 family members (read-only)</li>
              <li>Priority support</li>
            </ul>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="site-footer"></div>

  <script src="/js/header-loader.js"></script>
  <script src="/js/footer-loader.js"></script>
  <script>
    // Create client with session persistence + URL detection
    const SB = supabase.createClient(
      window.MEMOIR_SUPABASE_URL,
      window.MEMOIR_SUPABASE_ANON,
      { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } }
    );

    const pageTitle    = document.getElementById('pageTitle');
    const accountBlurb = document.getElementById('accountBlurb');
    const accountActs  = document.getElementById('accountActions');
    const subBlurb     = document.getElementById('subBlurb');

    function firstName(full){ return (full||'').trim().split(/\s+/)[0] || ''; }

    async function renderSettings(){
      // Read session
      const { data: { user }, error } = await SB.auth.getUser();

      if (!user || error) {
        pageTitle.textContent = 'Settings';
        accountBlurb.innerHTML = 'You are <strong class="warn">not signed in</strong>.';
        accountActs.innerHTML = `
          <a class="pill primary" href="/login.html">Sign in</a>
        `;
        subBlurb.textContent = 'Sign in to see or change your plan.';
        return;
      }

      // Fetch profile for name + plan
      let profile = null;
      try {
        const { data } = await SB
          .from('profiles')
          .select('full_name, subscription_plan')
          .eq('user_id', user.id)
          .single();
        profile = data || {};
      } catch {}

      const full = profile?.full_name || user.email || 'Your account';
      pageTitle.textContent = 'Settings';
      accountBlurb.innerHTML = `Signed in as <strong class="ok">${full}</strong> (${user.email})`;
      accountActs.innerHTML = `
        <a class="pill" href="/stories.html">My Stories</a>
        <a class="pill" href="/record.html">Record</a>
        <button class="pill" id="signOutBtn">Sign out</button>
      `;
      document.getElementById('signOutBtn').onclick = async ()=>{
        await SB.auth.signOut();
        location.href = '/login.html';
      };

      // Plan status
      const plan = profile?.subscription_plan || 'free';
      subBlurb.textContent = `Current plan: ${plan}`;
    }

    // Render on load and when we regain focus (helps after email confirmation)
    document.addEventListener('DOMContentLoaded', renderSettings);
    window.addEventListener('focus', renderSettings);

    // Also re-render if the auth state changes on this tab
    SB.auth.onAuthStateChange((_event, _session) => { renderSettings(); });
  </script>
</body>
</html>
