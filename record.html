<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Record — Memoir</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1/dist/umd/supabase.js"></script>
</head>
<body>
  <div id="site-header"></div>
  <script src="/js/header.js"></script>

  <main class="mk-container mk-grid cols-2">
    <section class="mk-card" style="padding:18px">
      <h2 class="mk-h2">Record</h2>

      <!-- Big round record -->
      <div style="display:flex;justify-content:center;margin:12px 0 8px">
        <button id="btnRec" class="mk-cta" style="width:180px;height:180px;border-radius:9999px;font-size:18px">Record</button>
      </div>

      <!-- Transcript under the button -->
      <div class="mk-card" style="padding:12px; margin-top:10px">
        <div class="mk-muted" style="margin-bottom:6px">Transcript</div>
        <div id="transcript" style="min-height:120px; white-space:pre-wrap">Your words will appear here…</div>
      </div>

      <div class="mk-grid cols-2" style="margin-top:12px">
        <div>
          <label class="mk-muted">Title</label>
          <input id="title" style="width:100%; padding:10px; border:1px solid var(--mk-border); border-radius:12px; background:#fff">
        </div>
        <div>
          <label class="mk-muted">When did it happen?</label>
          <input id="when" placeholder='e.g. "spring 1974" or 1988-05-10' style="width:100%; padding:10px; border:1px solid var(--mk-border); border-radius:12px; background:#fff">
        </div>
      </div>

      <!-- Photo attach -->
      <div style="margin-top:12px">
        <label class="mk-muted">Attach a photo (optional)</label><br/>
        <input id="photo" type="file" accept="image/*">
      </div>

      <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap">
        <button id="save" class="mk-cta">Save story</button>
        <button id="clear" class="mk-cta outline">Clear</button>
      </div>
    </section>

    <aside class="mk-card" style="padding:18px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 class="mk-h2" style="margin:0">Today’s suggested prompts</h3>
        <button id="refreshPrompts" class="mk-chip">Suggest other prompts</button>
      </div>
      <div id="prompts" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px"></div>

      <div style="margin-top:16px">
        <h3 class="mk-h2">Library</h3>
        <div id="library" class="mk-muted">No items yet.</div>
      </div>
    </aside>
  </main>

  <script>
    // ====== Supabase client (replace with your project values if not already present elsewhere) ======
    const SUPABASE_URL = "https://jrjqciywlijhhcxfxywh.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpyanFjaXl3bGlqaGhjeGZ4eXdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MDQ2NzEsImV4cCI6MjA3MTA4MDY3MX0.5FeQxu_N7q-1Br00yJu4E-TKTZK4U4ZnJ4jpRo7Atak";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{persistSession:true,detectSessionInUrl:false} });

    // ====== Guided prompts (4 at a time) ======
    const STOCK = {
      en:["Childhood","Family","School","Work","Love","War","Travel","Traditions","Holidays","Lessons","Advice","Turning-points"],
      fr:["Enfance","Famille","École","Travail","Amour","Guerre","Voyages","Traditions","Fêtes","Leçons","Conseils","Déclics"],
      nl:["Jeugd","Familie","School","Werk","Liefde","Oorlog","Reizen","Tradities","Feestdagen","Lessen","Advies","Keerpunt"],
      es:["Infancia","Familia","Escuela","Trabajo","Amor","Guerra","Viajes","Tradiciones","Fiestas","Lecciones","Consejos","Puntos-clave"]
    };
    function pick4(list){ const arr=[...list]; arr.sort(()=>Math.random()-0.5); return arr.slice(0,4); }
    function renderPrompts(){
      const lang = localStorage.getItem('mk.lang') || 'en';
      const wrap = document.getElementById('prompts'); wrap.innerHTML='';
      pick4(STOCK[lang]||STOCK.en).forEach(word=>{
        const b=document.createElement('button'); b.className='mk-chip'; b.textContent=word;
        b.onclick=()=>{ document.getElementById('title').value = word; };
        wrap.appendChild(b);
      });
    }
    document.getElementById('refreshPrompts').onclick = renderPrompts;
    renderPrompts();

    // ====== Recording UX (placeholder) ======
    const recBtn = document.getElementById('btnRec');
    const transcriptEl = document.getElementById('transcript');
    let recOn = false;
    recBtn.onclick = () => {
      recOn = !recOn;
      recBtn.textContent = recOn ? 'Stop' : 'Record';
      // You already wired Whisper chunking server-side; here we just show a note.
      if (recOn) transcriptEl.textContent = 'Listening… (audio is being chunked to server Whisper)';
    };

    // ====== Save story (DB + optional photo to Storage) ======
    function parseApproxDate(input){
      if(!input) return { label:'', sort:null };
      const s=input.trim().toLowerCase();
      const iso=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/); if(iso){const d=new Date(+iso[1],+iso[2]-1,+iso[3]);return{label:input,sort:d.toISOString().slice(0,10)};}
      const year=s.match(/(\d{4})/); if(year){const d=new Date(+year[1],0,1);return{label:input,sort:d.toISOString().slice(0,10)};}
      return { label:input, sort:null };
    }

    async function uploadPhoto(file, userId){
      if(!file) return null;
      const path = `${userId}/${Date.now()}_${file.name}`;
      const { data, error } = await sb.storage.from('memoir-images').upload(path, file, { upsert:false });
      if(error){ console.warn(error); return null; }
      const { data: pub } = sb.storage.from('memoir-images').getPublicUrl(path);
      return pub.publicUrl || null;
    }

    async function saveStory(){
      const { data:{ user } } = await sb.auth.getUser();
      if(!user){ alert('Please sign in.'); return; }

      const title = document.getElementById('title').value.trim() || 'Story';
      const when = parseApproxDate(document.getElementById('when').value);
      const text = transcriptEl.textContent.replace('Your words will appear here…','').trim();
      const photoFile = document.getElementById('photo').files[0];
      const photoUrl = await uploadPhoto(photoFile, user.id);

      const { error } = await sb.from('stories').insert({
        user_id: user.id,
        title,
        transcript: text || '(audio-only)',
        original_transcript: text || null,
        happened_label: when.label,
        happened_sort: when.sort,
        created_at: new Date().toISOString()
      });
      if(error){ alert('Save failed'); console.error(error); return; }
      alert('Saved!');
    }
    document.getElementById('save').onclick = saveStory;
    document.getElementById('clear').onclick = ()=>{ transcriptEl.textContent='Your words will appear here…'; };
  </script>
</body>
</html>
