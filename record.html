<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Memoir — Record</title>
</head>
<body>
  <!-- shared header -->
  <!-- paste the SHARED HEADER block here -->
  <div class="container">
    <div class="grid two">
      <section class="card" style="padding:16px">
        <div class="grid two" style="align-items:start">
          <div>
            <div class="pill" style="display:flex;gap:8px">
              <button id="tabGuided" class="btn ghost" data-i18n="guided">Guided</button>
              <button id="tabFree"   class="btn ghost" data-i18n="free">Free</button>
            </div>

            <!-- Guided block -->
            <div id="guidedBlock" style="margin-top:12px">
              <div class="muted" data-i18n="todays_suggestions">Today’s suggested prompts</div>
              <div id="prompts" class="grid" style="grid-template-columns:repeat(2,minmax(0,1fr));margin-top:8px"></div>
              <button id="refresh" class="btn" style="margin-top:8px" data-i18n="refresh_prompts">Suggest other prompts</button>
            </div>

            <!-- Free block -->
            <div id="freeBlock" style="display:none;margin-top:12px" class="muted" data-i18n="free">Free</div>

            <div style="margin-top:14px">
              <label class="muted" data-i18n="title_label">Title</label>
              <input id="title" class="input" placeholder="e.g. My first school day">
            </div>

            <div style="margin-top:10px">
              <label class="muted" data-i18n="when_label">When did this happen?</label>
              <input id="when" class="input" placeholder='e.g. "summer 1945", "early 2018", "15 Feb 1972"'>
            </div>

            <div style="margin-top:14px">
              <label class="muted" data-i18n="add_photo">Add a photo (optional)</label>
              <input id="photo" type="file" accept="image/*" class="input">
              <img id="photoPreview" style="margin-top:8px;max-width:100%;border-radius:12px;display:none"/>
            </div>
          </div>

          <!-- Record + transcript column -->
          <div style="text-align:center">
            <button id="recBtn" class="round big" data-i18n="start_recording">Start Recording</button>
            <div class="muted" id="recHint" style="margin-top:6px"></div>

            <div class="card" style="margin-top:12px;padding:12px">
              <div id="transcript" class="muted" style="min-height:160px;white-space:pre-wrap" data-i18n="transcript_placeholder">Your words will appear here…</div>
            </div>

            <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
              <button id="save" class="btn primary" data-i18n="save_story" disabled>Save story</button>
            </div>
          </div>
        </div>
      </section>

      <aside class="card" style="padding:16px">
        <div class="muted" style="margin-bottom:8px">Library (latest)</div>
        <div id="library"></div>
      </aside>
    </div>
  </div>

<script>
/* ---------- Supabase ---------- */
const supabaseClient = window.supabase.createClient(
  "https://jrjqciywlijhhcxfxywh.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpyanFjaXl3bGlqaGhjeGZ4eXdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MDQ2NzEsImV4cCI6MjA3MTA4MDY3MX0.5FeQxu_N7q-1Br00yJu4E-TKTZK4U4ZnJ4jpRo7Atak",
  { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:false } }
);

let sessionUser = null;
(async()=>{
  const { data:{ session } } = await supabaseClient.auth.getSession();
  if(!session){ location.replace('login.html'); return; }
  sessionUser = session.user;
  applyI18N();
  renderPrompts(); loadLatest();
})();

/* ---------- Guided prompts + voice hint (same IDs you gave me) ---------- */
const TOPIC_WORDS = {
  en:["Childhood","Family","School","Work","Love","War","Travel","Traditions","Holidays","Lessons","Advice","Turning-points"],
  fr:["Enfance","Famille","École","Travail","Amour","Guerre","Voyages","Traditions","Fêtes","Leçons","Conseils","Déclics"],
  nl:["Jeugd","Familie","School","Werk","Liefde","Oorlog","Reizen","Tradities","Feestdagen","Lessen","Advies","Keerpunt"],
  es:["Infancia","Familia","Escuela","Trabajo","Amor","Guerra","Viajes","Tradiciones","Fiestas","Lecciones","Consejos","Puntos-clave"]
};
function pick4(arr){ const a=[...arr]; const out=[]; while(out.length<4 && a.length){ out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]); } return out; }
function renderPrompts(){
  const lang = getLang();
  const wrap = document.getElementById('prompts'); wrap.innerHTML='';
  pick4(TOPIC_WORDS[lang]||TOPIC_WORDS.en).forEach(w=>{
    const d=document.createElement('div'); d.className='chip'; d.textContent=w;
    d.onclick=()=>{ document.getElementById('title').value = w; speakHint(lang, w); };
    wrap.appendChild(d);
  });
}
document.getElementById('refresh').onclick=renderPrompts;

// Light voice prompt (fallback)
function speakHint(code, word){
  const sentence = {
    en:`Tell me something about your ${word.toLowerCase()}.`,
    fr:`Parlez-moi de votre ${word.toLowerCase()}.`,
    nl:`Vertel iets over je ${word.toLowerCase()}.`,
    es:`Cuéntame sobre tu ${word.toLowerCase()}.`,
  }[code] || `Tell me something about your ${word.toLowerCase()}.`;

  if('speechSynthesis' in window){
    const u = new SpeechSynthesisUtterance(sentence);
    u.lang = ({en:'en-US',fr:'fr-FR',nl:'nl-NL',es:'es-ES'})[code] || 'en-US';
    speechSynthesis.cancel(); speechSynthesis.speak(u);
  }
}

/* ---------- Photo preview ---------- */
const photoInput = document.getElementById('photo');
const photoPreview = document.getElementById('photoPreview');
let photoFile = null;
photoInput.onchange = (e)=>{
  photoFile = e.target.files?.[0] || null;
  if(photoFile){
    const url = URL.createObjectURL(photoFile);
    photoPreview.src = url; photoPreview.style.display='block';
  }else{
    photoPreview.style.display='none';
  }
};

/* ---------- Recording + transcript (prefers chunked, falls back to Web Speech) ---------- */
const recBtn = document.getElementById('recBtn');
const transcriptEl = document.getElementById('transcript');
const saveBtn = document.getElementById('save');

let recorder=null, mediaStream=null, audioChunks=[], recording=false, audioBlob=null;

async function startRecording(){
  // Use MediaRecorder to capture audio; your server Whisper endpoint can accept blobs
  mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
  recorder = new MediaRecorder(mediaStream);
  audioChunks = [];
  recorder.ondataavailable = (e)=>{ if(e.data.size) audioChunks.push(e.data); };
  recorder.onstop = ()=>{ audioBlob = new Blob(audioChunks, { type:'audio/webm' }); saveBtn.disabled = false; };
  recorder.start(1000);
  // if you have a chunked Whisper endpoint, you can POST e.data in ondataavailable here.
  // For now, we record and send once on stop to /api/transcribe.
  recording=true; recBtn.textContent=t('stop_recording'); recBtn.classList.add('pulse');
  transcriptEl.textContent = t('transcript_placeholder');
}

async function stopRecording(){
  recording=false;
  recBtn.textContent=t('start_recording'); recBtn.classList.remove('pulse');
  if(recorder && recorder.state!=='inactive'){ recorder.stop(); }
  if(mediaStream){ mediaStream.getTracks().forEach(tr=>tr.stop()); }
  // Send audio for transcription (Whisper server)
  try{
    const fd = new FormData();
    fd.append('audio', audioBlob, 'memoir.webm');
    fd.append('lang', getLang());
    const r = await fetch('/api/transcribe', { method:'POST', body:fd });
    if(r.ok){
      const j = await r.json();
      transcriptEl.textContent = j.text || '';
    }else{
      transcriptEl.textContent = '(transcription failed)';
    }
  }catch(e){
    console.warn(e); transcriptEl.textContent='(transcription unavailable)';
  }
}

recBtn.onclick = ()=> recording ? stopRecording() : startRecording();

/* ---------- Save story to Supabase (upload files + insert row) ---------- */
function parseApproxDate(input){
  if(!input) return { label:'', sort:null };
  const s=input.trim().toLowerCase();
  const iso=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
  if(iso){ const d=new Date(+iso[1],+iso[2]-1,+iso[3]); return {label:input, sort:d.toISOString().slice(0,10)}; }
  const yOnly=s.match(/(\d{4})/);
  if(yOnly){ const d=new Date(+yOnly[1],0,1); return {label:input, sort:d.toISOString().slice(0,10)}; }
  return { label:input, sort:null };
}

async function uploadToBucket(bucket, file, filename){
  const path = `${sessionUser.id}/${Date.now()}-${filename}`;
  const { data, error } = await supabaseClient.storage.from(bucket).upload(path, file, { upsert:false });
  if(error) throw error;
  const { data: pub } = supabaseClient.storage.from(bucket).getPublicUrl(path);
  return pub.publicUrl;
}

document.getElementById('save').onclick = async ()=>{
  const title = document.getElementById('title').value.trim() || 'Story';
  const when  = parseApproxDate(document.getElementById('when').value);
  const text  = transcriptEl.textContent.trim();

  if(!text){ alert('Nothing to save yet.'); return; }

  saveBtn.disabled = true;

  let audioUrl=null, photoUrl=null;
  try{
    if(audioBlob){ audioUrl = await uploadToBucket('memoir-audio', audioBlob, 'audio.webm'); }
    if(photoFile){ photoUrl = await uploadToBucket('memoir-images', photoFile, photoFile.name || 'photo.jpg'); }

    const { error } = await supabaseClient
      .from('stories')
      .insert({
        user_id: sessionUser.id,
        title, transcript: text,
        audio_url: audioUrl, photo_url: photoUrl,
        happened_label: when.label, happened_sort: when.sort
      });

    if(error) throw error;

    alert('Saved!');
    document.getElementById('title').value='';
    document.getElementById('when').value='';
    transcriptEl.textContent=t('transcript_placeholder');
    photoInput.value=''; photoFile=null; photoPreview.style.display='none';
    saveBtn.disabled=false;
    loadLatest();
  }catch(e){
    console.error(e);
    alert('Save failed: ' + (e.message||e));
    saveBtn.disabled=false;
  }
};

/* ---------- Tabs ---------- */
const tabGuided = document.getElementById('tabGuided');
const tabFree   = document.getElementById('tabFree');
const guidedBlock = document.getElementById('guidedBlock');
const freeBlock   = document.getElementById('freeBlock');
tabGuided.onclick = ()=>{ guidedBlock.style.display='block'; freeBlock.style.display='none'; };
tabFree.onclick   = ()=>{ guidedBlock.style.display='none';  freeBlock.style.display='block'; };

/* ---------- Library preview ---------- */
async function loadLatest(){
  const { data, error } = await supabaseClient
    .from('stories')
    .select('id,title,created_at,photo_url')
    .eq('user_id', sessionUser.id)
    .order('created_at',{ascending:false})
    .limit(5);
  const box = document.getElementById('library'); box.innerHTML='';
  if(error || !data?.length){ box.innerHTML='<div class="muted">No stories yet.</div>'; return; }
  data.forEach(s=>{
    const row = document.createElement('div');
    row.className='grid'; row.style.gridTemplateColumns='60px 1fr';
    row.style.alignItems='center';
    row.style.marginBottom='10px';
    row.innerHTML = `
      <img src="${s.photo_url||'assets/book-1.jpg'}" style="width:56px;height:56px;object-fit:cover;border-radius:10px;border:1px solid #eee"/>
      <div>
        <div style="font-weight:600">${s.title||'Story'}</div>
        <div class="muted" style="font-size:12px">${new Date(s.created_at).toLocaleString()}</div>
      </div>
    `;
    box.appendChild(row);
  });
}
</script>
</body>
</html>
