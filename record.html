<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Record â€” Memoir</title>
<link rel="stylesheet" href="/styles.css"/>
</head>
<body>

<nav class="nav">
  <div class="nav-inner container">
    <div class="brand"><div class="logo"></div> Memoir</div>
    <div class="links">
      <a class="btn" href="/landing.html">About</a>
      <a class="btn" href="/stories.html">My Stories</a>
      <select class="btn" data-lang>
        <option value="en">ðŸ‡¬ðŸ‡§ English</option>
        <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
        <option value="nl">ðŸ‡³ðŸ‡± Nederlands</option>
        <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
      </select>
      <a class="btn" href="/login.html">Login</a>
    </div>
  </div>
</nav>

<main class="container">
  <section class="card">
    <div class="grid-two">
      <div>
        <div class="segment">
          <button id="tabGuided" class="tab active">Guided</button>
          <button id="tabFree" class="tab">Free</button>
          <span class="badge" id="planBadge">Plan: â€¦</span>
        </div>

        <!-- Big mic button first -->
        <div style="display:flex;gap:16px;align-items:center;margin:14px 0">
          <button id="mic" class="mic-big" aria-pressed="false">Record</button>
          <div class="muted" id="recHint">Your words will appear below.</div>
        </div>

        <div id="guidedBlock">
          <div class="label">Today's prompts</div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <div id="promptRow" class="segment"></div>
            <button class="btn" id="refreshPrompts">Refresh</button>
          </div>
        </div>

        <div class="label">Transcript</div>
        <div id="transcript" class="area" aria-live="polite">Your words will appear hereâ€¦</div>

        <div class="segment" style="margin-top:12px">
          <button id="save" class="btn primary" disabled>Save story</button>
          <button id="clear" class="btn">Clear</button>
        </div>
      </div>

      <aside>
        <div class="label">Title</div>
        <input id="title" class="input" placeholder="Story title (optional)"/>
        <div class="label">When did this happen?</div>
        <input id="when" class="input" placeholder='e.g., "summer 1945", "early 2018", "15 Feb 1972"'/>
        <div class="label">Add photo</div>
        <input id="photo" type="file" accept="image/*" class="input"/>

        <div class="label">Library</div>
        <div id="library" class="gallery"></div>
      </aside>
    </div>
  </section>
</main>

<script>
  // ---------- ENV + Supabase ----------
  window.ENV = { SUPABASE_URL: "{{SUPABASE_URL}}", SUPABASE_ANON_KEY: "{{SUPABASE_ANON_KEY}}" };
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1/dist/umd/supabase.js"></script>
<script src="/app.js"></script>
<script>
(async function(){
  const supabase = window.supabaseClient;
  const { data: { session } } = await supabase.auth.getSession();
  if(!session){ window.location.replace('/login.html'); return; }
  const user = session.user;

  // ---- UI refs
  const $=id=>document.getElementById(id);
  const mic=$('mic'), transcriptEl=$('transcript'), save=$('save'), clearBtn=$('clear');
  const titleEl=$('title'), whenEl=$('when'), photoEl=$('photo');
  const promptRow=$('promptRow'), refreshBtn=$('refreshPrompts');
  const tabGuided=$('tabGuided'), tabFree=$('tabFree'), guidedBlock=$('guidedBlock');
  const library=$('library');

  // ---- Plan badge (reads profiles)
  (async()=>{
    const { data: profile } = await supabase.from('profiles').select('plan, trial_end, role').single();
    const badge=document.getElementById('planBadge');
    const trialUntil = profile?.trial_end ? new Date(profile.trial_end) : null;
    const trialActive = trialUntil && Date.now() < trialUntil.getTime();
    const isAdmin = profile?.role === 'admin';
    if(isAdmin) badge.textContent='Plan: Admin';
    else if (profile?.plan==='premium' || trialActive) badge.textContent='Plan: Premium';
    else badge.textContent='Plan: Free';
  })();

  // ---- Topics (4 at a time)
  const TOPICS = {
    en:["Childhood","Family","School","Work","Love","War","Travel","Traditions","Holidays","Lessons","Advice","Turning-points"],
    fr:["Enfance","Famille","Ã‰cole","Travail","Amour","Guerre","Voyages","Traditions","FÃªtes","LeÃ§ons","Conseils","DÃ©clics"],
    es:["Infancia","Familia","Escuela","Trabajo","Amor","Guerra","Viajes","Tradiciones","Fiestas","Lecciones","Consejos","Puntos-clave"],
    nl:["Jeugd","Familie","School","Werk","Liefde","Oorlog","Reizen","Tradities","Feestdagen","Lessen","Advies","Keerpunt"]
  };
  function draw4(){
    const code = (localStorage.getItem('memoir.lang') || 'en');
    const arr = (TOPICS[code]||TOPICS.en).slice();
    const picks=[];
    while(picks.length<4 && arr.length){ picks.push(arr.splice(Math.floor(Math.random()*arr.length),1)[0]); }
    promptRow.innerHTML='';
    picks.forEach(word=>{
      const b=document.createElement('button'); b.className='btn'; b.textContent=word;
      b.onclick=()=>{ titleEl.value=word; };
      promptRow.appendChild(b);
    });
  }
  refreshBtn.onclick=draw4; draw4();

  // ---- Guided toggle
  tabGuided.onclick=()=>{ tabGuided.classList.add('active'); tabFree.classList.remove('active'); guidedBlock.style.display='block'; };
  tabFree.onclick=()=>{ tabFree.classList.add('active'); tabGuided.classList.remove('active'); guidedBlock.style.display='none'; };

  // ---- Recording (simple browser SR for now; you can swap to chunked Whisper)
  let recognition=null, recActive=false;
  function startRec(){
    const SR = window.webkitSpeechRecognition || window.SpeechRecognition;
    if(!SR){ alert('Speech recognition not available in this browser.'); return; }
    recognition=new SR();
    const code=(localStorage.getItem('memoir.lang')||'en');
    const BCP={en:'en-US',fr:'fr-FR',es:'es-ES',nl:'nl-NL'};
    recognition.lang = BCP[code]||'en-US';
    recognition.continuous=true; recognition.interimResults=true;
    let full='';
    recognition.onresult=(e)=>{
      let inter='';
      for(let i=e.resultIndex;i<e.results.length;i++){
        const r=e.results[i]; if(r.isFinal) full+=r[0].transcript+' '; else inter+=r[0].transcript;
      }
      const txt=(full+inter).trim();
      transcriptEl.textContent = txt || 'Your words will appear hereâ€¦';
      save.disabled = !txt;
    };
    recognition.onend=()=>{ stopRec(); };
    try{ recognition.start(); }catch{}
    mic.classList.add('pulse'); mic.textContent='Stop';
    recActive=true;
  }
  function stopRec(){
    try{ recognition && recognition.stop(); }catch{}
    mic.classList.remove('pulse'); mic.textContent='Record';
    recActive=false;
  }
  mic.onclick=()=>{ recActive?stopRec():startRec(); };

  // ---- Basic approx date parser
  function parseApproxDate(input){
    if(!input) return { label:'', sort:null };
    const s=input.trim().toLowerCase();
    const iso=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/); if(iso){const d=new Date(+iso[1],+iso[2]-1,+iso[3]);return{label:input,sort:d.toISOString().slice(0,10)};}
    const yOnly=s.match(/(\d{4})/); if(yOnly){const d=new Date(+yOnly[1],0,1);return{label:input,sort:d.toISOString().slice(0,10)};}
    const season=s.match(/^(early|mid|late)?\s*(spring|summer|autumn|fall|winter)\s+(\d{4})$/);
    if(season){const y=+season[3];const base={spring:2,summer:5,autumn:8,fall:8,winter:11}[season[2]];let m=base,day=1;if(season[1]==='mid')day=10;if(season[1]==='late')day=20;const d=new Date(y,m,day);return{label:input,sort:d.toISOString().slice(0,10)};}
    return { label:input, sort:null };
  }

  // ---- Save story (to Supabase)
  async function uploadImageIfAny(userId){
    const f = photoEl.files?.[0];
    if(!f) return null;
    const path = `${userId}/${Date.now()}-${f.name.replace(/\s+/g,'_')}`;
    const { error } = await supabase.storage.from('memoir-images').upload(path, f, { upsert:false });
    if (error) { alert('Photo upload failed: '+error.message); return null; }
    return path;
  }

  save.onclick = async () => {
    const text = transcriptEl.textContent.trim();
    if (!text) return;
    const when = parseApproxDate(whenEl.value);
    const image_path = await uploadImageIfAny(user.id);

    const { error } = await supabase.from('stories').insert({
      user_id: user.id,
      title: titleEl.value || 'Story',
      transcript: text,
      original_transcript: text,
      happened_label: when.label,
      happened_sort: when.sort,
      created_at: new Date().toISOString(),
      // audio_url: null, // wire later if needed
      // duration_sec: null,
      // image path goes to storage, we store the path string:
      // Add a column image_path text (nullable) to stories if you don't have it yet.
      image_path
    });
    if (error) { alert('Save failed: '+error.message); return; }

    // reset
    transcriptEl.textContent='Your words will appear hereâ€¦';
    titleEl.value=''; whenEl.value=''; photoEl.value='';
    save.disabled=true;

    loadLibrary(); // refresh small library on the side
    alert('Saved!');
  };

  clearBtn.onclick=()=>{ transcriptEl.textContent='Your words will appear hereâ€¦'; save.disabled=true; };

  // ---- Mini library (recent stories)
  async function loadLibrary(){
    const { data, error } = await supabase
      .from('stories')
      .select('id,title,created_at,image_path')
      .eq('user_id', user.id)
      .order('created_at', { ascending:false })
      .limit(6);
    if (error) return;
    library.innerHTML='';
    (data||[]).forEach(s=>{
      const div=document.createElement('div'); div.className='thumb';
      div.innerHTML = s.image_path
        ? `<img src="${supabase.storage.from('memoir-images').getPublicUrl(s.image_path).data.publicUrl}" alt="">`
        : `<div style="padding:10px" class="muted">${(s.title||'Story')}</div>`;
      library.appendChild(div);
    });
  }
  loadLibrary();
})();
</script>
</body>
</html>
