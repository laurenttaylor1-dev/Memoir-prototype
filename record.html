<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Memoir â€” Record</title>
  <link rel="stylesheet" href="/styles.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1/dist/umd/supabase.js"></script>
  <script defer src="/app.js"></script>
</head>
<body class="mk">
  <!-- HEADER (paste header.html if you donâ€™t have includes) -->
  <div id="header-slot">
    <header class="mk-header">
      <a href="/landing.html" class="mk-brand">
        <span class="mk-logo"></span>
        <div class="mk-title">
          <strong data-i18n="brand">MEMOIR APP</strong>
          <small data-i18n="tagline">Preserve your memories forever</small>
        </div>
      </a>
      <nav class="mk-nav">
        <a href="/landing.html" class="mk-pill" data-i18n="nav.home">Home</a>
        <a href="/login.html" class="mk-pill" data-i18n="nav.login">Login</a>
        <a href="/record.html" class="mk-pill mk-active" data-i18n="nav.record">Record</a>
        <a href="/stories.html" class="mk-pill" data-i18n="nav.stories">My Stories</a>
        <div class="mk-lang">
          <button class="mk-pill" data-lang-button id="langButton">ðŸ‡¬ðŸ‡§ English</button>
          <div class="mk-lang-menu" data-lang-menu id="langMenu">
            <button data-lang="en">ðŸ‡¬ðŸ‡§ English</button>
            <button data-lang="fr">ðŸ‡«ðŸ‡· FranÃ§ais</button>
            <button data-lang="nl">ðŸ‡³ðŸ‡± Nederlands</button>
            <button data-lang="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</button>
          </div>
        </div>
      </nav>
    </header>
  </div>

  <main class="mk-container">
    <h1 class="mk-page" data-i18n="recordHeader">Record</h1>

    <section class="mk-record-grid">
      <!-- Big round record button -->
      <div class="mk-rec-left mk-card">
        <button id="recordBtn" class="mk-record-btn">Record</button>
        <div class="mk-rec-meta">
          <span id="timer">00:00</span>
          <span id="status" class="mk-muted"></span>
        </div>

        <div class="mk-prompts">
          <div class="mk-prompts-top">
            <div class="mk-prompts-title" data-i18n="promptsTitle">Todayâ€™s suggested prompts</div>
            <button id="refreshPrompts" class="mk-pill" data-i18n="promptsRefresh">Suggest other prompts</button>
          </div>
          <div id="promptChips" class="mk-chips"></div>
        </div>

        <label class="mk-label" data-i18n="notes">Notes (optional)</label>
        <textarea id="notes" class="mk-input" rows="3" placeholder=""></textarea>
      </div>

      <!-- Text + form -->
      <div class="mk-rec-right mk-card">
        <div id="transcript" class="mk-transcript">â€¦</div>

        <label class="mk-label" data-i18n="titleLabel">Title</label>
        <input id="title" class="mk-input" placeholder="Story title"/>

        <label class="mk-label" data-i18n="whenLabel">When did this happen?</label>
        <input id="when" class="mk-input" placeholder='e.g. "summer 1945", "early 2018", "15 Feb 1972"' />

        <label class="mk-label" data-i18n="addPhoto">Add Photo (optional)</label>
        <input id="photo" type="file" accept="image/*" class="mk-file"/>

        <div class="mk-actions">
          <button id="save" class="mk-btn mk-btn-primary" data-i18n="saveStory">Save story</button>
        </div>
      </div>
    </section>
  </main>

  <script>
  // ====== Transcription (live via browser) + Whisper chunk uploads ======
  const transcriptEl = document.getElementById('transcript');
  const recordBtn = document.getElementById('recordBtn');
  const timerEl = document.getElementById('timer');
  const statusEl = document.getElementById('status');
  const chipsEl = document.getElementById('promptChips');
  const refreshBtn = document.getElementById('refreshPrompts');

  let recActive=false, recognition=null, mediaStream=null, mediaRec=null, chunkTimer=null, sec=0;
  let liveText='';

  function hhmmss(s){ const m=Math.floor(s/60).toString().padStart(2,'0'); const r=(s%60).toString().padStart(2,'0'); return `${m}:${r}`; }

  function renderPrompts(lang){
    chipsEl.innerHTML='';
    const words = window.getPromptWords(lang);
    // pick 4 random
    const picks = [...words].sort(()=>Math.random()-0.5).slice(0,4);
    picks.forEach(w=>{
      const b=document.createElement('button'); b.className='mk-chip'; b.textContent=w;
      b.onclick=()=>{ document.getElementById('title').value = w; };
      chipsEl.appendChild(b);
    });
  }
  document.addEventListener('lang-changed', (e)=> renderPrompts(e.detail.lang));
  renderPrompts(localStorage.getItem('memoir.lang')||'en');
  refreshBtn.onclick=()=>renderPrompts(localStorage.getItem('memoir.lang')||'en');

  // Start/stop
  recordBtn.addEventListener('click', async ()=>{
    if(recActive) { stopAll(); return; }
    await startAll();
  });

  async function startAll(){
    // SpeechRecognition live
    const SR = window.webkitSpeechRecognition || window.SpeechRecognition;
    if(SR){
      recognition = new SR();
      const map={en:'en-US',fr:'fr-FR',nl:'nl-NL',es:'es-ES'};
      recognition.lang = map[localStorage.getItem('memoir.lang')||'en'] || 'en-US';
      recognition.continuous=true; recognition.interimResults=true;
      let full='';
      recognition.onresult=(e)=>{
        let inter='';
        for(let i=e.resultIndex;i<e.results.length;i++){
          const r=e.results[i]; if(r.isFinal) full+=r[0].transcript+' '; else inter+=r[0].transcript;
        }
        liveText=(full+inter).trim();
        transcriptEl.textContent = liveText || 'â€¦';
      };
      try{ recognition.start(); }catch{}
    }

    // MediaRecorder for Whisper chunks
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true });
    mediaRec = new MediaRecorder(mediaStream, { mimeType: 'audio/webm' });
    mediaRec.ondataavailable = async (ev)=>{
      if(ev.data && ev.data.size){
        // fire-and-forget chunk to server (queue if offline)
        uploadChunk(ev.data).catch(()=>queueChunk(ev.data));
      }
    };
    mediaRec.start(5000); // request 5s chunks

    sec=0; timerEl.textContent='00:00'; statusEl.textContent='';
    chunkTimer=setInterval(()=>{ sec++; timerEl.textContent = hhmmss(sec); },1000);

    recordBtn.classList.add('mk-recording');
    recActive=true;
  }

  function stopAll(){
    try{ recognition && recognition.stop(); }catch{}
    try{ mediaRec && mediaRec.state!=='inactive' && mediaRec.stop(); }catch{}
    try{ mediaStream && mediaStream.getTracks().forEach(t=>t.stop()); }catch{}
    if(chunkTimer){ clearInterval(chunkTimer); chunkTimer=null; }
    recordBtn.classList.remove('mk-recording');
    recActive=false;
  }

  // Offline queue (simple localStorage fallback)
  function queueChunk(blob){
    const reader=new FileReader();
    reader.onload = ()=>{
      const arr = JSON.parse(localStorage.getItem('memoir.chunkQ')||'[]');
      arr.push(reader.result); // dataURL
      localStorage.setItem('memoir.chunkQ', JSON.stringify(arr));
    };
    reader.readAsDataURL(blob);
  }
  async function flushQueue(){
    const arr = JSON.parse(localStorage.getItem('memoir.chunkQ')||'[]');
    if(!arr.length) return;
    for(const dataURL of arr){
      const res = await fetch(dataURL); const b = await res.blob();
      try{ await uploadChunk(b); }catch{ return; } // stop on first failure
    }
    localStorage.removeItem('memoir.chunkQ');
  }
  window.addEventListener('online', flushQueue);

  async function uploadChunk(blob){
    const fd = new FormData();
    fd.append('audio', blob, 'chunk.webm');
    fd.append('lang', localStorage.getItem('memoir.lang')||'en');
    await fetch('/api/whisper-chunk',{ method:'POST', body:fd });
  }

  // ===== Save to cloud =====
  async function saveStoryToCloud(){
    const title = document.getElementById('title').value.trim() || 'Story';
    const when = window.parseApproxDate(document.getElementById('when').value);
    const note = document.getElementById('notes').value.trim();
    const photo = document.getElementById('photo').files[0];

    statusEl.textContent = (I18N[localStorage.getItem('memoir.lang')||'en']||I18N.en).saving;

    // optional photo upload to Storage
    let photoPath = null;
    if(photo){
      const { data: { user } } = await supabase.auth.getUser();
      if(!user){ alert('Please log in first.'); statusEl.textContent=''; return; }
      const filePath = `${user.id}/${Date.now()}_${photo.name}`;
      const r = await supabase.storage.from('memoir-images').upload(filePath, photo, { upsert:false });
      if(!r.error) photoPath = filePath;
    }

    // Insert story row (RLS trigger fills user_id)
    const { data, error } = await supabase.from('stories').insert({
      title, transcript: liveText, original_transcript: liveText,
      happened_label: when.label, happened_sort: when.sort
    }).select('id').single();

    if(error){ 
      console.error(error);
      statusEl.textContent = (I18N[localStorage.getItem('memoir.lang')||'en']||I18N.en).saveFailed;
      alert('Save failed: ' + (error.message||'RLS/permission'));
      return;
    }

    // Ask server to finalize Whisper on whatever was captured
    try{
      const fd = new FormData();
      fd.append('story_id', data.id);
      fd.append('lang', localStorage.getItem('memoir.lang')||'en');
      await fetch('/api/whisper-final',{ method:'POST', body:fd });
    }catch(e){ console.warn('whisper-final failed (will be retried by cron if you add one)', e); }

    statusEl.textContent = (I18N[localStorage.getItem('memoir.lang')||'en']||I18N.en).saved;
    stopAll();
  }

  document.getElementById('save').addEventListener('click', saveStoryToCloud);
  </script>
</body>
</html>
