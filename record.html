<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Memoir — Record</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div id="site-header"></div>

  <main class="container">
    <h1 class="section-title" id="recTitle">Record</h1>

    <section class="grid">
      <!-- LEFT: Capture / Modes / Prompts -->
      <div class="card">
        <div class="micZone">
          <button id="mic" class="mic" aria-pressed="false">Record</button>
          <div class="muted"><span class="timer" id="timer">00:00</span></div>
        </div>

        <div class="toggle">
          <button class="pill active" id="btnFree"></button>
          <button class="pill" id="btnGuided"></button>
        </div>

        <div class="label" id="todays"></div>
        <div id="promptWrap" class="prompt-grid" aria-live="polite"></div>

        <div class="label" id="notesLbl">Notes (optional)</div>
        <textarea id="notes" placeholder="Add a quick note…"></textarea>

        <div style="margin-top:12px"><a href="/stories.html" class="btn" id="toStories">My Stories</a></div>
      </div>

      <!-- RIGHT: Meta + Transcript -->
      <div class="card">
        <div class="label" id="titleLbl">Title</div>
        <input id="title" type="text" placeholder="Story title" />

        <div class="label" id="whenLbl">When did this happen?</div>
        <input id="when" type="text" placeholder='e.g. "summer 1945", "early 2018", "15 Feb 1972"' />

        <div class="label" id="photoLbl">Add photo (optional)</div>
        <input id="photo" type="file" accept="image/*" />

        <div class="label" style="margin-top:14px" id="transLbl">Transcript</div>
        <div id="transcript" class="transcript" aria-live="polite">Your words will appear here…</div>
        <div class="hint" id="asrHint" style="margin-top:6px"></div>

        <div class="row" style="margin-top:14px"><button id="saveBtn" class="btn primary">Save story</button></div>
      </div>
    </section>
  </main>

  <div id="site-footer"></div>

  <script src="/js/lang.js" defer></script>
  <script src="/js/header-loader.js" defer></script>
  <script>
    /* ===== Localization for Record page ===== */
    function applyRecLang(code){
      const t = (window.MEMOIR_I18N?.strings?.[code]) || window.MEMOIR_I18N.strings.en;
      recTitle.textContent = t.recTitle;
      btnFree.textContent = t.freeMode;
      btnGuided.textContent = t.guidedMode;
      todays.textContent = t.todays;
      notesLbl.textContent = t.notes;
      titleLbl.textContent = t.titleLabel;
      whenLbl.textContent = t.whenLabel;
      photoLbl.textContent = t.photoLabel;
      transLbl.textContent = t.transcriptLabel;
      asrHint.textContent = t.transcriptHint;
      saveBtn.textContent = t.save;
      toStories.textContent = t.myStories || "My Stories";
    }
    window.addEventListener('memoir:lang', e=>{ applyRecLang(e.detail.code); renderPrompts(e.detail.code); });
    document.addEventListener('DOMContentLoaded', ()=>{ const code = window.MEMOIR_I18N?.getLang?.() || 'en'; applyRecLang(code); renderPrompts(code); });

    /* ===== FREE / GUIDED toggle ===== */
    let mode = 'free';
    btnFree.onclick = ()=>{ mode='free'; btnFree.classList.add('active'); btnGuided.classList.remove('active'); renderPrompts(window.MEMOIR_I18N?.getLang?.() || 'en'); };
    btnGuided.onclick = ()=>{ mode='guided'; btnGuided.classList.add('active'); btnFree.classList.remove('active'); renderPrompts(window.MEMOIR_I18N?.getLang?.() || 'en'); };

    /* ===== Prompts: 4 topics + OTHER, equal size ===== */
    const TOPIC_WORDS = {
      en:["Childhood","Family","School","Work","Other"],
      fr:["Enfance","Famille","École","Travail","Autre"],
      nl:["Jeugd","Familie","School","Werk","Overig"],
      es:["Infancia","Familia","Escuela","Trabajo","Otro"]
    };

    function renderPrompts(code){
      const wrap = document.getElementById('promptWrap'); wrap.innerHTML='';
      const words = (TOPIC_WORDS[code]||TOPIC_WORDS.en).slice(0,5);

      // In FREE mode show placeholders; in GUIDED mode clickable
      words.forEach(w=>{
        const b = document.createElement('button');
        b.className = 'chip'; b.textContent = w;
        if(mode==='guided'){
          b.onclick = ()=>{ document.getElementById('title').value = (w==='Other'||w==='Autre'||w==='Otro'||w==='Overig') ? '' : w; speakPrompt(w, code); };
        }else{
          b.disabled = true; b.style.opacity='.65';
        }
        wrap.appendChild(b);
      });
    }

    /* ===== ElevenLabs voice (via your /api/voice.js) ===== */
    async function speakPrompt(text, code){
      try{
        const r = await fetch(`/api/voice.js?text=${encodeURIComponent(text)}&lang=${encodeURIComponent(code)}`);
        const { url } = await r.json();
        const audio = new Audio(url);
        audio.play().catch(()=>{});
      }catch(e){ /* silent */ }
    }

    /* ===== Recording + chunk upload (same as before, with live partials) ===== */
    const mic = document.getElementById('mic');
    const timerEl = document.getElementById('timer');
    const transcriptEl = document.getElementById('transcript');
    const asrHint = document.getElementById('asrHint');
    let recActive=false, startAt=0, tick=null, media=null, chunks=[];

    async function startRec(){
      try{
        media = await navigator.mediaDevices.getUserMedia({ audio:true });
        const mr = new MediaRecorder(media, { mimeType: 'audio/webm' });
        chunks=[];
        mr.ondataavailable = e => { if(e.data && e.data.size) chunks.push(e.data); };
        mr.onstop = async () => {
          const blob = new Blob(chunks, { type:'audio/webm' });
          await uploadChunk(blob);
        };
        mr.start(1000);
        window._memoirRecorder = mr;
        mic.textContent='Stop'; mic.classList.add('pulse');
        recActive=true; startAt=Date.now(); tick=setInterval(()=>updateTimer(),1000);
        asrHint.textContent = (window.MEMOIR_I18N?.strings?.[window.MEMOIR_I18N.getLang()]||{}).transcriptHint || 'Recording…';
      }catch(e){ alert('Microphone permission denied.'); }
    }
    function stopRec(){
      try{ window._memoirRecorder && window._memoirRecorder.stop(); }catch{}
      try{ media && media.getTracks().forEach(t=>t.stop()); }catch{}
      clearInterval(tick); tick=null;
      mic.textContent='Record'; mic.classList.remove('pulse'); recActive=false; updateTimer(0);
    }
    mic.onclick = ()=> recActive ? stopRec() : startRec();
    function updateTimer(forceZero){
      const ms = forceZero===0 ? 0 : (Date.now()-startAt);
      const s = Math.floor(ms/1000); const mm = String(Math.floor(s/60)).padStart(2,'0'); const ss = String(s%60).padStart(2,'0');
      timerEl.textContent = `${mm}:${ss}`;
    }

    async function uploadChunk(blob){
      try{
        const lang = window.MEMOIR_I18N?.getLang?.() || 'en';
        const r = await fetch('/api/transcribe-chunk', { method:'POST', headers:{'x-memoir-lang':lang}, body:blob });
        if(!r.ok) throw new Error('upload_failed');
        const data = await r.json().catch(()=>null);
        if(data?.partial){ transcriptEl.textContent = data.partial; }
        asrHint.textContent='Listening…';
      }catch(e){
        asrHint.textContent='Offline or server unavailable — audio will be saved locally and sent later.';
      }
    }

    document.getElementById('saveBtn').onclick = async()=>{
      if(recActive) stopRec();
      const title = document.getElementById('title').value.trim() || 'Story';
      const when  = document.getElementById('when').value.trim() || '';
      const notes = document.getElementById('notes').value.trim() || '';
      const photo = document.getElementById('photo').files?.[0] || null;
      const text  = (transcriptEl.textContent || '').trim();
      if(!text){ alert('There is no transcript yet. Say a few words, then try again.'); return; }

      const fd = new FormData();
      fd.append('title', title); fd.append('when', when); fd.append('notes', notes); fd.append('text', text);
      if(photo) fd.append('photo', photo);
      try{
        const r = await fetch('/api/transcribe-story', { method:'POST', body: fd });
        if(!r.ok) throw new Error('save_failed');
        alert('Saved! You can find it in My Stories.');
        window.location.href = '/stories.html';
      }catch(e){ alert('Save failed. If you are offline, it will retry when connected.'); }
    };
  </script>
</body>
</html>
