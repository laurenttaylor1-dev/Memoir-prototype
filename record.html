<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Memoir App â€” Record</title>
<link rel="preload" href="assets/book-1.jpg" as="image">
<style>
:root{
  --bg:#f8f7f5; --card:#ffffff; --ink:#2f2a25; --muted:#6f6a65;
  --brand:#6b4c2f; --brand2:#7b5bff; --border:#e8e5e1; --radius:18px;
  --shadow:0 10px 30px rgba(0,0,0,.06);
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

/* Header shared with landing */
header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border);box-shadow:0 2px 10px rgba(0,0,0,.02)}
.nav{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px}
.brandblock{display:flex;flex-direction:column}
.brand{font-weight:800;color:var(--ink)}
.sub{color:var(--muted);font-size:12px}
.menu{display:flex;gap:10px;align-items:center}
.pill{display:inline-flex;align-items:center;justify-content:center;background:#fff;border:1px solid var(--border);border-radius:999px;padding:10px 14px;min-width:110px;font-weight:600;color:var(--ink);text-decoration:none}
.pill:hover{border-color:#ddd}
select.pill{appearance:none;padding-right:28px;background:
  linear-gradient(45deg,transparent 50%,#999 50%) right 10px center/8px 8px no-repeat,
  linear-gradient(135deg,#999 50%,transparent 50%) right 4px center/8px 8px no-repeat, #fff}

.wrap{max-width:1100px;margin:20px auto;padding:0 16px}

/* Layout */
.grid{display:grid;grid-template-columns:1fr;gap:16px}
@media(min-width:1000px){.grid{grid-template-columns:1.2fr .8fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}

/* Tabs */
.tabs{display:flex;gap:8px;margin-bottom:8px}
.tab{border:1px solid var(--border);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer}
.tab.active{background:#efe9e3;border-color:#e0d7cf;font-weight:700}

/* Prompts */
.headrow{display:flex;align-items:center;justify-content:space-between;gap:10px}
.h2{font-weight:800}
.small{color:var(--muted);font-size:12px}
.chips{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin-top:10px}
@media(min-width:760px){.chips{grid-template-columns:repeat(4,minmax(0,1fr))}}
.chip{display:flex;align-items:center;justify-content:center;border:1px solid #e4ded7;background:#f6f1eb;border-radius:12px;height:40px;font-weight:700;cursor:pointer}
.chip:active{transform:translateY(1px)}
.refresh{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}

/* Form */
.label{font-size:12px;font-weight:800;color:var(--muted);letter-spacing:.06em;margin-top:10px}
.input, .area{width:100%;border:1px solid var(--border);border-radius:12px;background:#fff;color:inherit;padding:10px}
.area{min-height:200px}

/* Recorder */
.recbox{display:flex;flex-direction:column;align-items:center;gap:10px;margin:12px 0}
.mic{width:190px;height:190px;border-radius:999px;border:0;background:radial-gradient(70% 70% at 50% 30%, #ff5a5f, #a26a2a);color:#fff;font-weight:800;font-size:18px;cursor:pointer;box-shadow:0 16px 50px rgba(162,106,42,.35)}
.mic.pulse{animation:pulse 1.6s infinite ease-in-out}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.04)}100%{transform:scale(1)}}
.meter{display:flex;gap:8px;align-items:center;width:100%;max-width:420px}
.bar{flex:1;height:10px;background:#eee;border-radius:999px;overflow:hidden}
.bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--brand),var(--brand2))}
.btn{background:var(--brand);color:#fff;border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer}
.btn.secondary{background:#fff;border:1px solid var(--border);color:var(--ink)}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
</style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="nav">
      <div class="brandblock">
        <div class="brand">MEMOIR APP â€” Preserve your memories forever</div>
        <div class="sub">Record â€¢ Transcribe â€¢ Share privately with family</div>
      </div>
      <nav class="menu">
        <a class="pill" href="landing.html">Home</a>
        <a class="pill" href="login.html">Login</a>
        <a class="pill" href="record.html">Record</a>
        <a class="pill" href="stories.html">My Stories</a>
        <select class="pill" id="lang">
          <option value="en">ðŸ‡ºðŸ‡¸ English</option>
          <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
          <option value="nl">ðŸ‡³ðŸ‡± Nederlands</option>
          <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
        </select>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- Left: recorder + transcript -->
      <section class="card">
        <div class="tabs">
          <div id="tabGuided" class="tab active">Guided</div>
          <div id="tabFree" class="tab">Free</div>
        </div>

        <div id="guidedBlock">
          <div class="headrow">
            <div class="h2">Todayâ€™s suggested prompts</div>
            <button id="refreshPrompts" class="refresh">Suggest other prompts</button>
          </div>
          <div class="small">Tap a topic to hear a gentle question and prefill the title.</div>
          <div id="chips" class="chips"></div>
        </div>

        <div class="label">Title</div>
        <input id="title" class="input" placeholder="Story title (optional)"/>

        <div class="label">When did this happen?</div>
        <input id="when" class="input" placeholder='e.g., "summer 1945", "early 2018", "15 Feb 1972"' />

        <div class="label">Transcript</div>
        <div id="transcript" class="area" aria-live="polite">Your words will appear hereâ€¦</div>

        <div class="recbox">
          <button id="mic" class="mic" aria-pressed="false">Record</button>
          <div class="meter" id="meter" style="display:none">
            <div class="bar"><div id="bar"></div></div>
            <div id="remain" class="small">120s</div>
          </div>
          <div id="asr" class="small"></div>
        </div>

        <div class="actions">
          <button id="save" class="btn" disabled>Save story</button>
          <button id="clear" class="btn secondary">Clear</button>
        </div>
      </section>

      <!-- Right: library preview (local for now) -->
      <aside class="card">
        <div class="h2">Library (recent)</div>
        <div id="lib" class="small">No stories yet.</div>
        <div class="actions"><a class="btn secondary" href="stories.html">Open full library</a></div>
      </aside>
    </div>
  </main>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1/dist/umd/supabase.js"></script>
<script>
/* ====== Config ====== */
const SUPABASE_URL  = "https://jrjqciywlijhhcxfxywh.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpyanFjaXl3bGlqaGhjeGZ4eXdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MDQ2NzEsImV4cCI6MjA3MTA4MDY3MX0.5FeQxu_N7q-1Br00yJu4E-TKTZK4U4ZnJ4jpRo7Atak";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON,{auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:false}});

/* ====== Session guard ====== */
(async()=>{
  const { data:{session} } = await supabase.auth.getSession();
  if(!session) location.replace('login.html');
})();

/* ====== Language & prompts ====== */
const langSel=document.getElementById('lang');
langSel.value = localStorage.getItem('memoir.lang') || 'en';
langSel.addEventListener('change',()=>{localStorage.setItem('memoir.lang', langSel.value); renderPrompts();});

const TOPIC_WORDS={
  en:["Childhood","Family","School","Work","Love","War","Travel","Traditions","Holidays","Lessons","Advice","Turning-points"],
  fr:["Enfance","Famille","Ã‰cole","Travail","Amour","Guerre","Voyages","Traditions","FÃªtes","LeÃ§ons","Conseils","DÃ©clics"],
  nl:["Jeugd","Familie","School","Werk","Liefde","Oorlog","Reizen","Tradities","Feestdagen","Lessen","Advies","Keerpunt"],
  es:["Infancia","Familia","Escuela","Trabajo","Amor","Guerra","Viajes","Tradiciones","Fiestas","Lecciones","Consejos","Puntos-clave"]
};
const PROMPT_SENTENCE={
  en:(w)=>({Childhood:"Tell me something about your youth."}[w]||`Tell me about ${w.toLowerCase()}.`),
  fr:(w)=>({Enfance:"Parlez-moi de votre jeunesse, dâ€™un souvenir marquant."}[w]||`Parlez-moi de ${w.toLowerCase()}.`),
  nl:(w)=>({Jeugd:"Vertel me iets over je jeugd."}[w]||`Vertel over ${w.toLowerCase()}.`),
  es:(w)=>({Infancia:"CuÃ©ntame algo sobre tu juventud."}[w]||`HÃ¡blame de ${w.toLowerCase()}.`)
};
const BCP={en:'en-US',fr:'fr-FR',nl:'nl-NL',es:'es-ES'};

const chipsEl=document.getElementById('chips');
const refreshBtn=document.getElementById('refreshPrompts');
function pick4(arr){ const a=[...arr]; const out=[]; while(a.length && out.length<4){ out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]); } return out;}
function speak(sentence, code){ if(!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(sentence); u.lang=BCP[code]||'en-US'; speechSynthesis.cancel(); speechSynthesis.speak(u); }
function renderPrompts(){
  const lang=langSel.value||'en';
  const all=TOPIC_WORDS[lang]||TOPIC_WORDS.en;
  const four=pick4(all);
  chipsEl.innerHTML='';
  four.forEach(word=>{
    const c=document.createElement('div'); c.className='chip'; c.textContent=word;
    c.onclick=()=>{ document.getElementById('title').value=word; speak((PROMPT_SENTENCE[lang]||PROMPT_SENTENCE.en)(word), lang);}
    chipsEl.appendChild(c);
  });
}
refreshBtn.onclick=renderPrompts;

/* ====== Recorder (browser Web Speech as placeholder) ====== */
const transcriptEl=document.getElementById('transcript'), saveBtn=document.getElementById('save');
const meter=document.getElementById('meter'), bar=document.getElementById('bar'), remain=document.getElementById('remain'), mic=document.getElementById('mic'), asr=document.getElementById('asr');
let recognition=null, recOn=false, elapsed=0, timer=null; const CAP=120;
function startRec(){
  const SR=window.webkitSpeechRecognition||window.SpeechRecognition;
  if(!SR){ asr.textContent='Speech recognition not available in this browser.'; return; }
  recognition=new SR(); recognition.lang=BCP[langSel.value]||'en-US'; recognition.continuous=true; recognition.interimResults=true;
  let full='';
  recognition.onresult=(e)=>{ let inter=''; for(let i=e.resultIndex;i<e.results.length;i++){ const r=e.results[i]; if(r.isFinal) full+=r[0].transcript+' '; else inter+=r[0].transcript; } const txt=(full+inter).trim(); transcriptEl.textContent=txt||'Your words will appear hereâ€¦'; saveBtn.disabled=!txt; };
  recognition.onend=()=>stopRec();
  try{ recognition.start(); }catch{}
  mic.classList.add('pulse'); mic.textContent='Stop Recording'; asr.textContent='Transcribingâ€¦'; meter.style.display='flex';
  elapsed=0; remain.textContent=CAP+'s'; bar.style.width='0%';
  timer=setInterval(()=>{ elapsed++; bar.style.width=(elapsed/CAP*100)+'%'; remain.textContent=Math.max(0,CAP-elapsed)+'s'; if(elapsed>=CAP) stopRec(); },1000);
  recOn=true;
}
function stopRec(){
  try{ recognition&&recognition.stop(); }catch{}
  if(timer){ clearInterval(timer); timer=null; }
  mic.classList.remove('pulse'); mic.textContent='Record'; asr.textContent=''; recOn=false;
}
mic.onclick=()=>{ recOn?stopRec():startRec(); };

/* ====== Save locally (you already have Supabase pipeline elsewhere) ====== */
const LS='memoir.stories';
const load=()=>{try{return JSON.parse(localStorage.getItem(LS)||'[]')}catch{return[]}};
const store=(list)=>localStorage.setItem(LS,JSON.stringify(list));
const lib=document.getElementById('lib');
function renderLib(){
  const items=load(); if(!items.length){ lib.textContent='No stories yet.'; return; }
  lib.innerHTML = items.slice(0,4).map(s=>`â€¢ ${s.title||'Story'} â€” <span class="small">${s.happened_label||new Date(s.created).toLocaleString()}</span>`).join('<br>');
}
document.getElementById('clear').onclick=()=>{ transcriptEl.textContent='Your words will appear hereâ€¦'; saveBtn.disabled=true; };
document.getElementById('save').onclick=()=>{
  const text=transcriptEl.textContent.trim(); if(!text) return;
  const t=document.getElementById('title').value||'Story'; const when=document.getElementById('when').value||'';
  const items=load(); items.unshift({title:t,text,created:new Date().toISOString(),happened_label:when}); store(items); renderLib();
  transcriptEl.textContent='Your words will appear hereâ€¦'; saveBtn.disabled=true; document.getElementById('title').value=''; document.getElementById('when').value='';
  alert('Saved locally. (Supabase save can be added next.)');
};

/* Init */
renderPrompts(); renderLib();
</script>
</body>
</html>
